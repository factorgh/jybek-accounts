"use strict";exports.id=9962,exports.ids=[9962],exports.modules={9962:(t,e,n)=>{n.d(e,{LedgerService:()=>r});var a=n(777),i=n(5200);class r{static getDb(){return a.default.then(t=>t.db("jybek_accounts"))}static async postJournalEntry(t,e,n,r,o,c){let s=await this.getDb(),d=a.default.then(t=>t.startSession());try{let a=await d;await a.withTransaction(async()=>{let d=o.reduce((t,e)=>t+e.debitAmount,0),u=o.reduce((t,e)=>t+e.creditAmount,0);if(d!==u)throw Error(`Transaction does not balance. Debits: ${d}, Credits: ${u}`);if(0===d)throw Error("Transaction must have at least one non-zero amount.");for(let e of o)if(!await s.collection("accounts").findOne({_id:e.accountId,businessId:t,isActive:!0}))throw Error(`Account with ID ${e.accountId} not found or inactive.`);let l=await this.generateTransactionNumber(s,t),p={businessId:t,transactionNumber:l,transactionDate:e,description:n,reference:r,type:i.iU.ManualJournal,isReversed:!1,createdByUserId:c,createdAt:new Date,updatedAt:new Date},m=(await s.collection("transactions").insertOne(p,{session:a})).insertedId.toString(),w=o.map(t=>({transactionId:m,accountId:t.accountId,debitAmount:t.debitAmount,creditAmount:t.creditAmount,description:t.description,createdAt:new Date}));await s.collection("transactionLines").insertMany(w,{session:a}),await this.updateAccountBalances(s,t,w,a)});let u=await s.collection("transactions").findOne({businessId:t,transactionNumber:(await this.generateTransactionNumber(s,t)).replace(/\d+$/,String(parseInt((await this.generateTransactionNumber(s,t)).split("-").pop()||"0")-1))});if(!u)throw Error("Failed to retrieve created transaction");return u}catch(t){throw t}}static async postIncome(t,e,n,a,i,r,o,c){if(a<=0)throw Error("Income amount must be greater than zero.");let s=[{accountId:n,debitAmount:a,creditAmount:0,description:"Income received"},{accountId:e,debitAmount:0,creditAmount:a,description:r}];return await this.postJournalEntry(t,i,r,o,s,c)}static async postExpense(t,e,n,a,i,r,o,c){if(a<=0)throw Error("Expense amount must be greater than zero.");let s=[{accountId:e,debitAmount:a,creditAmount:0,description:r},{accountId:n,debitAmount:0,creditAmount:a,description:"Expense paid"}];return await this.postJournalEntry(t,i,r,o,s,c)}static async postOpeningBalance(t,e,n,a,i,r){if(e<0)throw Error("Opening balance cannot be negative.");return await this.postJournalEntry(t,i,"Opening Balance","OB-001",[{accountId:a,debitAmount:e,creditAmount:0,description:"Opening balance - Cash"},{accountId:n,debitAmount:0,creditAmount:e,description:"Opening balance - Owner's Capital"}],r)}static async reverseTransaction(t,e,n){let i=await this.getDb(),r=await i.collection("transactions").findOne({_id:t});if(!r)throw Error(`Transaction with ID ${t} not found.`);if(r.isReversed)throw Error("Transaction is already reversed.");let o=(await i.collection("transactionLines").find({transactionId:t}).toArray()).map(t=>({accountId:t.accountId,debitAmount:t.creditAmount,creditAmount:t.debitAmount,description:`Reversal: ${t.description}`})),c=await this.postJournalEntry(r.businessId,new Date,`Reversal: ${r.description} - ${e}`,`REV-${r.transactionNumber}`,o,n),s=await a.default.then(t=>t.startSession());return await s.withTransaction(async()=>{await i.collection("transactions").updateOne({_id:t},{$set:{isReversed:!0,reversedByTransactionId:c._id,updatedAt:new Date}},{session:s})}),c}static async generateTransactionNumber(t,e){let n=new Date().getFullYear(),a=`JE-${n}-`,i=await t.collection("transactions").find({businessId:e,transactionNumber:{$regex:`^${a}`}}).sort({transactionNumber:-1}).limit(1).toArray(),r=1;return i.length>0&&(r=parseInt(i[0].transactionNumber.split("-").pop()||"0")+1),`${a}${r.toString().padStart(6,"0")}`}static async updateAccountBalances(t,e,n,a){for(let r of n){let n=await t.collection("accounts").findOne({_id:r.accountId,businessId:e});if(!n)continue;let o=0;o=n.type===i.Qm.Asset||n.type===i.Qm.Expense?r.debitAmount-r.creditAmount:r.creditAmount-r.debitAmount,await t.collection("accounts").updateOne({_id:r.accountId},{$inc:{balance:o},$set:{updatedAt:new Date}},{session:a})}}}}};