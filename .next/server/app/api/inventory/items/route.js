"use strict";(()=>{var t={};t.id=8075,t.ids=[8075],t.modules={8013:t=>{t.exports=require("mongodb")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:t=>{t.exports=require("buffer")},6113:t=>{t.exports=require("crypto")},2781:t=>{t.exports=require("stream")},3837:t=>{t.exports=require("util")},8261:(t,e,n)=>{n.r(e),n.d(e,{headerHooks:()=>g,originalPathname:()=>p,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>v,serverHooks:()=>h,staticGenerationAsyncStorage:()=>A,staticGenerationBailout:()=>_});var i={};n.r(i),n.d(i,{GET:()=>y,POST:()=>I});var r=n(5419),a=n(9108),o=n(9678),s=n(8070),c=n(8013),l=n(777),d=n(739);class u{static getDb(){return l.default.then(t=>t.db("jybek_accounts"))}static async createInventoryItem(t,e){let n=await this.getDb(),i=l.default.then(t=>t.startSession());try{let r=await i,a=await r.withTransaction(async()=>{let t={...e,createdAt:new Date,updatedAt:new Date},i=(await n.collection("inventory_items").insertOne(t)).insertedId.toString(),r={itemId:i,warehouseLocation:"Main",quantityOnHand:e.currentStock||0,quantityReserved:0,lastUpdated:new Date};return await n.collection("stock_levels").insertOne(r),i});return await this.getInventoryItem(t,a)}finally{let t=await i;await t.endSession()}}static async getInventoryItem(t,e){let n=await this.getDb(),i=await n.collection("inventory_items").findOne({_id:new c.ObjectId(e),businessId:t});if(!i)throw Error("Inventory item not found");return{id:i._id.toString(),businessId:i.businessId,itemCode:i.itemCode,description:i.description,categoryId:i.categoryId,unitOfMeasure:i.unitOfMeasure,costMethod:i.costMethod,currentStock:i.currentStock,reorderPoint:i.reorderPoint,maxStock:i.maxStock,unitCost:i.unitCost,sellingPrice:i.sellingPrice,isActive:i.isActive,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async getInventoryItems(t){let e=await this.getDb();return(await e.collection("inventory_items").find({businessId:t,isActive:!0}).sort({description:1}).toArray()).map(t=>({id:t._id.toString(),businessId:t.businessId,itemCode:t.itemCode,description:t.description,categoryId:t.categoryId,unitOfMeasure:t.unitOfMeasure,costMethod:t.costMethod,currentStock:t.currentStock,reorderPoint:t.reorderPoint,maxStock:t.maxStock,unitCost:t.unitCost,sellingPrice:t.sellingPrice,isActive:t.isActive,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async adjustStock(t,e,n,i,r,a,o,s="Main"){let u=await this.getDb(),m=l.default.then(t=>t.startSession());try{let l=await m,y=await l.withTransaction(async()=>{let l=await u.collection("inventory_items").findOne({_id:new c.ObjectId(e),businessId:t});if(!l)throw Error("Inventory item not found");let m=i===d.UW.IN?l.unitCost:0,y=Math.abs(n)*m,I={itemId:e,movementType:i,quantity:n,unitCost:m,totalCost:y,referenceType:a,referenceId:o,movementDate:new Date,warehouseLocation:s,notes:r,createdAt:new Date},v=(await u.collection("inventory_movements").insertOne(I)).insertedId.toString(),f=await u.collection("stock_levels").findOne({itemId:e,warehouseLocation:s});if(f){let t=f.quantityOnHand+n;await u.collection("stock_levels").updateOne({_id:f._id},{$set:{quantityOnHand:t,lastUpdated:new Date}}),await u.collection("inventory_items").updateOne({_id:new c.ObjectId(e)},{$set:{currentStock:t,updatedAt:new Date}})}else await u.collection("stock_levels").insertOne({itemId:e,warehouseLocation:s,quantityOnHand:n,quantityReserved:0,lastUpdated:new Date});return v});return await this.getInventoryMovement(y)}finally{let t=await m;await t.endSession()}}static async getInventoryMovement(t){let e=await this.getDb(),n=await e.collection("inventory_movements").findOne({_id:new c.ObjectId(t)});if(!n)throw Error("Inventory movement not found");return{id:n._id.toString(),itemId:n.itemId,movementType:n.movementType,quantity:n.quantity,unitCost:n.unitCost,totalCost:n.totalCost,referenceType:n.referenceType,referenceId:n.referenceId,movementDate:n.movementDate,warehouseLocation:n.warehouseLocation,notes:n.notes,createdAt:n.createdAt}}static async getInventoryMovements(t,e,n,i){let r=await this.getDb(),a={};return e&&(a.itemId=e),(n||i)&&(a.movementDate={},n&&(a.movementDate.$gte=n),i&&(a.movementDate.$lte=i)),(await r.collection("inventory_movements").find(a).sort({movementDate:-1}).toArray()).map(t=>({id:t._id.toString(),itemId:t.itemId,movementType:t.movementType,quantity:t.quantity,unitCost:t.unitCost,totalCost:t.totalCost,referenceType:t.referenceType,referenceId:t.referenceId,movementDate:t.movementDate,warehouseLocation:t.warehouseLocation,notes:t.notes,createdAt:t.createdAt}))}static async calculateCOGS(t,e,n){let i=await this.getDb(),r=await i.collection("inventory_movements").find({itemId:e,movementType:d.UW.OUT,movementDate:{$gte:n.startDate,$lte:n.endDate}}).toArray(),a=await i.collection("inventory_items").findOne({_id:new c.ObjectId(e),businessId:t});if(!a)throw Error("Inventory item not found");return a.costMethod===d.eR.FIFO?await this.calculateFIFOCOGS(e,r,n):a.costMethod===d.eR.LIFO?await this.calculateLIFOCOGS(e,r,n):a.costMethod===d.eR.WEIGHTED_AVERAGE?r.reduce((t,e)=>t+(e.totalCost||0),0):r.reduce((t,e)=>t+(e.totalCost||0),0)}static async valueInventory(t,e,n){let i=await this.getDb(),r=await i.collection("inventory_items").find({businessId:t,isActive:!0}).toArray(),a=0,o=[];for(let t of r){let r=await i.collection("stock_levels").findOne({itemId:t._id.toString(),warehouseLocation:"Main"}),s=r?.quantityOnHand||0,c=0,l=s*(c=e===d.eR.FIFO?await this.getFIFOUnitValue(t._id.toString(),n):e===d.eR.LIFO?await this.getLIFOUnitValue(t._id.toString(),n):e===d.eR.WEIGHTED_AVERAGE?await this.getWeightedAverageUnitValue(t._id.toString(),n):t.unitCost||0);a+=l,o.push({itemId:t._id.toString(),quantity:s,unitValue:c,totalValue:l})}let s={businessId:t,valuationDate:n,valuationMethod:e,totalValue:a,itemCount:r.length,createdAt:new Date};return{id:(await i.collection("inventory_valuations").insertOne(s)).insertedId.toString(),businessId:t,valuationDate:n,valuationMethod:e,totalValue:a,itemValuations:o}}static async generateReorderSuggestions(t){let e=await this.getDb(),n=[];for(let i of(await e.collection("inventory_items").aggregate([{$match:{businessId:t,isActive:!0}},{$lookup:{from:"stock_levels",localField:"_id",foreignField:"itemId",as:"stockLevels"}},{$lookup:{from:"reorder_rules",localField:"_id",foreignField:"itemId",as:"reorderRules"}},{$match:{"reorderRules.isActive":!0}}]).toArray())){let t=i.stockLevels.find(t=>"Main"===t.warehouseLocation),e=i.reorderRules.find(t=>t.isActive);if(t&&e){let r=t.quantityAvailable||t.quantityOnHand;if(r<=e.reorderPoint){let t=this.calculateReorderUrgency(r,e.reorderPoint),a=e.reorderQuantity*(i.unitCost||0);n.push({itemId:i._id.toString(),itemCode:i.itemCode,description:i.description,currentStock:r,reorderPoint:e.reorderPoint,suggestedQuantity:e.reorderQuantity,urgency:t,estimatedCost:a})}}}return n.sort((t,e)=>{let n={critical:4,high:3,medium:2,low:1};return n[e.urgency]-n[t.urgency]})}static async createReorderRule(t,e){let n=await this.getDb(),i={...e,createdAt:new Date,updatedAt:new Date};return{id:(await n.collection("reorder_rules").insertOne(i)).insertedId.toString(),businessId:i.businessId,itemId:i.itemId,reorderPoint:i.reorderPoint,reorderQuantity:i.reorderQuantity,leadTimeDays:i.leadTimeDays,safetyStock:i.safetyStock,isActive:i.isActive,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async calculateFIFOCOGS(t,e,n){let i=await this.getDb(),r=await i.collection("inventory_movements").find({itemId:t,movementType:d.UW.IN,movementDate:{$lt:n.startDate}}).sort({movementDate:1}).toArray(),a=[];r.forEach(t=>{a.push({quantity:t.quantity,unitCost:t.unitCost||0})});let o=0;for(let t of e){let e=Math.abs(t.quantity),n=0;for(;e>0&&a.length>0;){let t=a[0],i=Math.min(e,t.quantity);n+=i*t.unitCost,e-=i,t.quantity-=i,t.quantity<=0&&a.shift()}o+=n}return o}static async calculateLIFOCOGS(t,e,n){let i=await this.getDb(),r=await i.collection("inventory_movements").find({itemId:t,movementType:d.UW.IN,movementDate:{$lt:n.startDate}}).sort({movementDate:-1}).toArray(),a=[];r.forEach(t=>{a.push({quantity:t.quantity,unitCost:t.unitCost||0})});let o=0;for(let t of e){let e=Math.abs(t.quantity),n=0;for(;e>0&&a.length>0;){let t=a[0],i=Math.min(e,t.quantity);n+=i*t.unitCost,e-=i,t.quantity-=i,t.quantity<=0&&a.shift()}o+=n}return o}static async getFIFOUnitValue(t,e){let n=await this.getDb(),i=await n.collection("inventory_movements").find({itemId:t,movementType:d.UW.IN,movementDate:{$lte:e}}).sort({movementDate:1}).toArray();if(0===i.length)return 0;let r=i.reduce((t,e)=>t+(e.totalCost||0),0),a=i.reduce((t,e)=>t+e.quantity,0);return a>0?r/a:0}static async getLIFOUnitValue(t,e){let n=await this.getDb(),i=await n.collection("inventory_movements").find({itemId:t,movementType:d.UW.IN,movementDate:{$lte:e}}).sort({movementDate:-1}).toArray();return 0===i.length?0:i[0]?.unitCost||0}static async getWeightedAverageUnitValue(t,e){let n=await this.getDb(),i=await n.collection("inventory_movements").find({itemId:t,movementType:d.UW.IN,movementDate:{$lte:e}}).toArray();if(0===i.length)return 0;let r=i.reduce((t,e)=>t+(e.totalCost||0),0),a=i.reduce((t,e)=>t+e.quantity,0);return a>0?r/a:0}static calculateReorderUrgency(t,e){let n=t/e;return n<=0?"critical":n<=.25?"high":n<=.5?"medium":"low"}static async getInventorySummary(t){let e=await this.getDb(),n=await e.collection("inventory_items").find({businessId:t,isActive:!0}).toArray(),i=[];for(let t of n){let n=await e.collection("stock_levels").findOne({itemId:t._id.toString(),warehouseLocation:"Main"}),r=await e.collection("reorder_rules").findOne({itemId:t._id.toString(),isActive:!0}),a=n?.quantityAvailable||n?.quantityOnHand||0,o=a*(t.unitCost||0),s=r&&a<=r.reorderPoint;i.push({id:t._id.toString(),itemCode:t.itemCode,description:t.description,currentStock:t.currentStock,availableStock:a,totalValue:o,unitCost:t.unitCost,sellingPrice:t.sellingPrice,reorderPoint:r?.reorderPoint,needsReorder:s})}return i}}var m=n(6953);async function y(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return s.Z.json({error:"Unauthorized"},{status:401});let n=(0,m.PZ)(e);if(!n)return s.Z.json({error:"Invalid token"},{status:401});let i=await u.getInventoryItems(n.businessId);return s.Z.json({success:!0,data:i})}catch(t){return console.error("Error fetching inventory items:",t),s.Z.json({error:"Failed to fetch inventory items"},{status:500})}}async function I(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return s.Z.json({error:"Unauthorized"},{status:401});let n=(0,m.PZ)(e);if(!n)return s.Z.json({error:"Invalid token"},{status:401});let i=await t.json(),r=await u.createInventoryItem(n.businessId,i);return s.Z.json({success:!0,data:r})}catch(t){return console.error("Error creating inventory item:",t),s.Z.json({error:"Failed to create inventory item"},{status:500})}}let v=new r.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/inventory/items/route",pathname:"/api/inventory/items",filename:"route",bundlePath:"app/api/inventory/items/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/inventory/items/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:f,staticGenerationAsyncStorage:A,serverHooks:h,headerHooks:g,staticGenerationBailout:_}=v,p="/api/inventory/items/route";function w(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:A})}},6953:(t,e,n)=>{n.d(e,{PZ:()=>l,e8:()=>c,sL:()=>d});var i=n(6082),r=n.n(i),a=n(6521),o=n.n(a);let s=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class c{static generateToken(t){let e={userId:t._id,email:t.email,businessId:t.businessId,role:t.role};return r().sign(e,s,{expiresIn:"24h"})}static verifyToken(t){try{return r().verify(t,s)}catch(t){throw Error("Invalid token")}}static async hashPassword(t){return await o().hash(t,12)}static async verifyPassword(t,e){return await o().compare(t,e)}static generateApiKey(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let n=0;n<32;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}}let l=c.verifyToken,d=c.verifyToken},777:(t,e,n)=>{n.r(e),n.d(e,{default:()=>a});var i=n(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let r=process.env.MONGODB_URI,a=new i.MongoClient(r,{}).connect()},739:(t,e,n)=>{var i,r,a,o,s,c,l,d,u,m,y,I,v,f,A,h,g,_,p;n.d(e,{E_:()=>v,UW:()=>c,Xy:()=>I,_q:()=>m,dm:()=>f,eR:()=>s,l5:()=>h,sA:()=>A,z1:()=>y}),function(t){t.ANNUAL="annual",t.QUARTERLY="quarterly",t.MONTHLY="monthly",t.PROJECT="project"}(i||(i={})),function(t){t.DRAFT="draft",t.SUBMITTED="submitted",t.APPROVED="approved",t.REJECTED="rejected",t.ARCHIVED="archived"}(r||(r={})),function(t){t.MONTHLY="monthly",t.QUARTERLY="quarterly",t.ANNUAL="annual"}(a||(a={})),function(t){t.OPTIMISTIC="optimistic",t.PESSIMISTIC="pessimistic",t.REALISTIC="realistic",t.CUSTOM="custom"}(o||(o={})),function(t){t.FIFO="fifo",t.LIFO="lifo",t.WEIGHTED_AVERAGE="weighted_average",t.SPECIFIC_IDENTIFICATION="specific_identification"}(s||(s={})),function(t){t.IN="in",t.OUT="out",t.ADJUSTMENT="adjustment",t.TRANSFER="transfer"}(c||(c={})),function(t){t.PURCHASE="purchase",t.SALE="sale",t.ADJUSTMENT="adjustment",t.TRANSFER="transfer",t.RETURN="return"}(l||(l={})),function(t){t.CHECKING="checking",t.SAVINGS="savings",t.BUSINESS="business",t.CREDIT_CARD="credit_card"}(d||(d={})),function(t){t.MANUAL="manual",t.FILE_IMPORT="file_import",t.API="api"}(u||(u={})),function(t){t.AUTO="auto",t.MANUAL="manual",t.RULE_BASED="rule_based"}(m||(m={})),function(t){t.AMOUNT_DIFFERENCE="amount_difference",t.MISSING_TRANSACTION="missing_transaction",t.DUPLICATE_TRANSACTION="duplicate_transaction",t.TIMING_DIFFERENCE="timing_difference"}(y||(y={})),function(t){t.MONTHLY="monthly",t.QUARTERLY="quarterly",t.ANNUAL="annual",t.SEMI_ANNUAL="semi_annual"}(I||(I={})),function(t){t.SALES="sales",t.INCOME="income",t.VAT="vat",t.GST="gst",t.WITHHOLDING="withholding",t.PAYROLL="payroll",t.PROPERTY="property"}(v||(v={})),function(t){t.DRAFT="draft",t.READY_TO_FILE="ready_to_file",t.FILED="filed",t.PAID="paid",t.OVERDUE="overdue",t.CANCELLED="cancelled"}(f||(f={})),function(t){t.STRAIGHT_LINE="straight_line",t.DECLINING_BALANCE="declining_balance",t.SUM_OF_YEARS="sum_of_years",t.UNITS_OF_PRODUCTION="units_of_production"}(A||(A={})),function(t){t.ACTIVE="active",t.UNDER_CONSTRUCTION="under_construction",t.DISPOSED="disposed",t.IMPAIRED="impaired",t.RETIRED="retired"}(h||(h={})),function(t){t.PPE="ppe",t.INTANGIBLE="intangible",t.INVESTMENT_PROPERTY="investment_property",t.BIOLOGICAL_ASSETS="biological_assets"}(g||(g={})),function(t){t.FAIR_VALUE_LESS_COSTS="fair_value_less_costs",t.VALUE_IN_USE="value_in_use"}(_||(_={})),function(t){t.SALE="sale",t.SCRAP="scrap",t.TRADE_IN="trade_in",t.DONATION="donation"}(p||(p={}))}};var e=require("../../../../webpack-runtime.js");e.C(t);var n=t=>e(e.s=t),i=e.X(0,[1638,6206,7145],()=>n(8261));module.exports=i})();