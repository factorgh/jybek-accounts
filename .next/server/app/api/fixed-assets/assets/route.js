"use strict";(()=>{var e={};e.id=8316,e.ids=[8316],e.modules={8013:e=>{e.exports=require("mongodb")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},442:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>y,originalPathname:()=>h,patchFetch:()=>E,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>D,staticGenerationAsyncStorage:()=>I,staticGenerationBailout:()=>_});var i={};a.r(i),a.d(i,{GET:()=>f,POST:()=>A});var s=a(5419),n=a(9108),r=a(9678),o=a(8070),c=a(8013),d=a(777),u=a(739);class l{static getDb(){return d.default.then(e=>e.db("jybek_accounts"))}static async createFixedAsset(e,t){let a=await this.getDb(),i=d.default.then(e=>e.startSession());try{let s=await i,n=await s.withTransaction(async()=>{let e={...t,createdAt:new Date,updatedAt:new Date},i=(await a.collection("fixed_assets").insertOne(e)).insertedId.toString();return await this.createInitialDepreciationSchedule(i,e),i});return await this.getFixedAsset(e,n)}finally{let e=await i;await e.endSession()}}static async getFixedAsset(e,t){let a=await this.getDb(),i=await a.collection("fixed_assets").findOne({_id:new c.ObjectId(t),businessId:e});if(!i)throw Error("Fixed asset not found");return{id:i._id.toString(),businessId:i.businessId,assetNumber:i.assetNumber,description:i.description,categoryId:i.categoryId,acquisitionDate:i.acquisitionDate,acquisitionCost:i.acquisitionCost,depreciationMethod:i.depreciationMethod,usefulLifeYears:i.usefulLifeYears,residualValue:i.residualValue,currentLocation:i.currentLocation,responsiblePerson:i.responsiblePerson,status:i.status,ifrsClassification:i.ifrsClassification,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async getFixedAssets(e){let t=await this.getDb();return(await t.collection("fixed_assets").find({businessId:e}).sort({description:1}).toArray()).map(e=>({id:e._id.toString(),businessId:e.businessId,assetNumber:e.assetNumber,description:e.description,categoryId:e.categoryId,acquisitionDate:e.acquisitionDate,acquisitionCost:e.acquisitionCost,depreciationMethod:e.depreciationMethod,usefulLifeYears:e.usefulLifeYears,residualValue:e.residualValue,currentLocation:e.currentLocation,responsiblePerson:e.responsiblePerson,status:e.status,ifrsClassification:e.ifrsClassification,createdAt:e.createdAt,updatedAt:e.updatedAt}))}static async calculateDepreciation(e,t){let a=await this.getDb(),i=await a.collection("fixed_assets").findOne({_id:new c.ObjectId(e)});if(!i)throw Error("Fixed asset not found");let s=await a.collection("depreciation_schedules").findOne({assetId:e,fiscalYear:t});if(s)return{id:s._id.toString(),assetId:s.assetId,fiscalYear:s.fiscalYear,openingCarryingAmount:s.openingCarryingAmount,depreciationExpense:s.depreciationExpense,closingCarryingAmount:s.closingCarryingAmount,accumulatedDepreciation:s.accumulatedDepreciation,calculationDate:s.calculationDate};let n=this.calculateDepreciationExpense(i,t),r=await a.collection("depreciation_schedules").find({assetId:e,fiscalYear:{$lt:t}}).sort({fiscalYear:-1}).limit(1).toArray(),o=r.length>0?r[0].accumulatedDepreciation+n:n,d=r.length>0?r[0].closingCarryingAmount:i.acquisitionCost,u={assetId:e,fiscalYear:t,openingCarryingAmount:d,depreciationExpense:n,closingCarryingAmount:d-n,accumulatedDepreciation:o,calculationDate:new Date};return{id:(await a.collection("depreciation_schedules").insertOne(u)).insertedId.toString(),assetId:u.assetId,fiscalYear:u.fiscalYear,openingCarryingAmount:u.openingCarryingAmount,depreciationExpense:u.depreciationExpense,closingCarryingAmount:u.closingCarryingAmount,accumulatedDepreciation:u.accumulatedDepreciation,calculationDate:u.calculationDate}}static async performImpairmentTest(e,t,a,i){let s=await this.getDb(),n=await s.collection("fixed_assets").findOne({_id:new c.ObjectId(e)});if(!n)throw Error("Fixed asset not found");let r=await s.collection("depreciation_schedules").find({assetId:e}).sort({fiscalYear:-1}).limit(1).toArray(),o=r.length>0?r[0].closingCarryingAmount:n.acquisitionCost,d=Math.max(0,o-i),l={assetId:e,testDate:t,carryingAmount:o,recoverableAmount:i,impairmentLoss:d,testMethod:a,performedBy:"system",createdAt:new Date},p=await s.collection("impairment_tests").insertOne(l);return d>0&&await s.collection("fixed_assets").updateOne({_id:new c.ObjectId(e)},{$set:{status:u.l5.IMPAIRED,updatedAt:new Date}}),{id:p.insertedId.toString(),assetId:l.assetId,testDate:l.testDate,carryingAmount:l.carryingAmount,recoverableAmount:l.recoverableAmount,impairmentLoss:l.impairmentLoss,testMethod:l.testMethod,performedBy:l.performedBy,createdAt:l.createdAt}}static async disposeAsset(e,t){let a=await this.getDb(),i=d.default.then(e=>e.startSession());try{let s=await i,n=await s.withTransaction(async()=>{let i=await a.collection("fixed_assets").findOne({_id:new c.ObjectId(e)});if(!i)throw Error("Fixed asset not found");let s=await a.collection("depreciation_schedules").find({assetId:e}).sort({fiscalYear:-1}).limit(1).toArray(),n=s.length>0?s[0].closingCarryingAmount:i.acquisitionCost,r=t.proceedsAmount||0,o=t.disposalCosts||0,d={...t,assetId:e,gainLossOnDisposal:r-o-n,disposedBy:"system",createdAt:new Date},l=await a.collection("asset_disposals").insertOne(d);return await a.collection("fixed_assets").updateOne({_id:new c.ObjectId(e)},{$set:{status:u.l5.DISPOSED,updatedAt:new Date}}),l.insertedId.toString()});return await this.getAssetDisposal(n)}finally{let e=await i;await e.endSession()}}static async createAssetCategory(e,t){let a=await this.getDb(),i={...t,businessId:e,createdAt:new Date,updatedAt:new Date};return{id:(await a.collection("asset_categories").insertOne(i)).insertedId.toString(),businessId:i.businessId,name:i.name,description:i.description,depreciationMethod:i.depreciationMethod,usefulLifeYears:i.usefulLifeYears,ifrsClassification:i.ifrsClassification,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async getAssetCategories(e){let t=await this.getDb();return(await t.collection("asset_categories").find({businessId:e}).sort({name:1}).toArray()).map(e=>({id:e._id.toString(),businessId:e.businessId,name:e.name,description:e.description,depreciationMethod:e.depreciationMethod,usefulLifeYears:e.usefulLifeYears,ifrsClassification:e.ifrsClassification,createdAt:e.createdAt,updatedAt:e.updatedAt}))}static async getDepreciationSchedules(e){let t=await this.getDb();return(await t.collection("depreciation_schedules").find({assetId:e}).sort({fiscalYear:1}).toArray()).map(e=>({id:e._id.toString(),assetId:e.assetId,fiscalYear:e.fiscalYear,openingCarryingAmount:e.openingCarryingAmount,depreciationExpense:e.depreciationExpense,closingCarryingAmount:e.closingCarryingAmount,accumulatedDepreciation:e.accumulatedDepreciation,calculationDate:e.calculationDate}))}static async getImpairmentTests(e){let t=await this.getDb();return(await t.collection("impairment_tests").find({assetId:e}).sort({testDate:-1}).toArray()).map(e=>({id:e._id.toString(),assetId:e.assetId,testDate:e.testDate,carryingAmount:e.carryingAmount,recoverableAmount:e.recoverableAmount,impairmentLoss:e.impairmentLoss,testMethod:e.testMethod,performedBy:e.performedBy,createdAt:e.createdAt}))}static async createInitialDepreciationSchedule(e,t){let a=await this.getDb(),i=new Date().getFullYear(),s=this.calculateDepreciationExpense(t,i),n={assetId:e,fiscalYear:i,openingCarryingAmount:t.acquisitionCost,depreciationExpense:s,closingCarryingAmount:t.acquisitionCost-s,accumulatedDepreciation:s,calculationDate:new Date};await a.collection("depreciation_schedules").insertOne(n)}static calculateDepreciationExpense(e,t){let{acquisitionCost:a,residualValue:i,usefulLifeYears:s,depreciationMethod:n,acquisitionDate:r}=e,o=t-r.getFullYear();if(o<0||o>=s)return 0;let c=a-i;switch(n){case u.sA.STRAIGHT_LINE:return c/s;case u.sA.DECLINING_BALANCE:return 2/s*Math.max(i,a-c/s*o);case u.sA.SUM_OF_YEARS:return c*(s-o)/(s*(s+1)/2);case u.sA.UNITS_OF_PRODUCTION:default:return c/s}}static async getAssetDisposal(e){let t=await this.getDb(),a=await t.collection("asset_disposals").findOne({_id:new c.ObjectId(e)});if(!a)throw Error("Asset disposal not found");return{id:a._id.toString(),assetId:a.assetId,disposalDate:a.disposalDate,disposalMethod:a.disposalMethod,proceedsAmount:a.proceedsAmount,disposalCosts:a.disposalCosts,gainLossOnDisposal:a.gainLossOnDisposal,buyerName:a.buyerName,disposalReference:a.disposalReference,disposedBy:a.disposedBy,createdAt:a.createdAt}}static async getAssetSummary(e){let t=await this.getDb(),a=await t.collection("fixed_assets").find({businessId:e}).toArray(),i=[];for(let e of a){let a=(await t.collection("depreciation_schedules").find({assetId:e._id.toString()}).sort({fiscalYear:-1}).limit(1).toArray())[0];i.push({id:e._id.toString(),assetNumber:e.assetNumber,description:e.description,acquisitionCost:e.acquisitionCost,currentCarryingAmount:a?a.closingCarryingAmount:e.acquisitionCost,accumulatedDepreciation:a?a.accumulatedDepreciation:0,netBookValue:a?a.closingCarryingAmount:e.acquisitionCost,acquisitionDate:e.acquisitionDate,usefulLifeYears:e.usefulLifeYears,ageInYears:Math.floor((new Date().getTime()-new Date(e.acquisitionDate).getTime())/31536e6),status:e.status})}return i}static async revalueAsset(e,t){let a=await this.getDb();if(!await a.collection("fixed_assets").findOne({_id:new c.ObjectId(e)}))throw Error("Fixed asset not found");let i=t.revaluedAmount-t.previousCarryingAmount,s={...t,assetId:e,revaluationSurplus:i,performedBy:"system",createdAt:new Date};return{id:(await a.collection("asset_revaluations").insertOne(s)).insertedId.toString(),assetId:s.assetId,revaluationDate:s.revaluationDate,previousCarryingAmount:s.previousCarryingAmount,revaluedAmount:s.revaluedAmount,revaluationSurplus:s.revaluationSurplus,valuationMethod:s.valuationMethod,valuerName:s.valuerName,performedBy:s.performedBy,createdAt:s.createdAt}}static async getAssetRevaluations(e){let t=await this.getDb();return(await t.collection("asset_revaluations").find({assetId:e}).sort({revaluationDate:-1}).toArray()).map(e=>({id:e._id.toString(),assetId:e.assetId,revaluationDate:e.revaluationDate,previousCarryingAmount:e.previousCarryingAmount,revaluedAmount:e.revaluedAmount,revaluationSurplus:e.revaluationSurplus,valuationMethod:e.valuationMethod,valuerName:e.valuerName,performedBy:e.performedBy,createdAt:e.createdAt}))}}var p=a(6953);async function f(e){try{let t=e.headers.get("Authorization")?.replace("Bearer ","");if(!t)return o.Z.json({error:"Unauthorized"},{status:401});let a=(0,p.PZ)(t);if(!a)return o.Z.json({error:"Invalid token"},{status:401});let i=await l.getFixedAssets(a.businessId);return o.Z.json({success:!0,data:i})}catch(e){return console.error("Error fetching fixed assets:",e),o.Z.json({error:"Failed to fetch fixed assets"},{status:500})}}async function A(e){try{let t=e.headers.get("Authorization")?.replace("Bearer ","");if(!t)return o.Z.json({error:"Unauthorized"},{status:401});let a=(0,p.PZ)(t);if(!a)return o.Z.json({error:"Invalid token"},{status:401});let i=await e.json(),s=await l.createFixedAsset(a.businessId,i);return o.Z.json({success:!0,data:s})}catch(e){return console.error("Error creating fixed asset:",e),o.Z.json({error:"Failed to create fixed asset"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/fixed-assets/assets/route",pathname:"/api/fixed-assets/assets",filename:"route",bundlePath:"app/api/fixed-assets/assets/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/fixed-assets/assets/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:I,serverHooks:D,headerHooks:y,staticGenerationBailout:_}=m,h="/api/fixed-assets/assets/route";function E(){return(0,r.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:I})}},6953:(e,t,a)=>{a.d(t,{PZ:()=>d,e8:()=>c,sL:()=>u});var i=a(6082),s=a.n(i),n=a(6521),r=a.n(n);let o=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class c{static generateToken(e){let t={userId:e._id,email:e.email,businessId:e.businessId,role:e.role};return s().sign(t,o,{expiresIn:"24h"})}static verifyToken(e){try{return s().verify(e,o)}catch(e){throw Error("Invalid token")}}static async hashPassword(e){return await r().hash(e,12)}static async verifyPassword(e,t){return await r().compare(e,t)}static generateApiKey(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let a=0;a<32;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}}let d=c.verifyToken,u=c.verifyToken},777:(e,t,a)=>{a.r(t),a.d(t,{default:()=>n});var i=a(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let s=process.env.MONGODB_URI,n=new i.MongoClient(s,{}).connect()},739:(e,t,a)=>{var i,s,n,r,o,c,d,u,l,p,f,A,m,g,I,D,y,_,h;a.d(t,{E_:()=>m,UW:()=>c,Xy:()=>A,_q:()=>p,dm:()=>g,eR:()=>o,l5:()=>D,sA:()=>I,z1:()=>f}),function(e){e.ANNUAL="annual",e.QUARTERLY="quarterly",e.MONTHLY="monthly",e.PROJECT="project"}(i||(i={})),function(e){e.DRAFT="draft",e.SUBMITTED="submitted",e.APPROVED="approved",e.REJECTED="rejected",e.ARCHIVED="archived"}(s||(s={})),function(e){e.MONTHLY="monthly",e.QUARTERLY="quarterly",e.ANNUAL="annual"}(n||(n={})),function(e){e.OPTIMISTIC="optimistic",e.PESSIMISTIC="pessimistic",e.REALISTIC="realistic",e.CUSTOM="custom"}(r||(r={})),function(e){e.FIFO="fifo",e.LIFO="lifo",e.WEIGHTED_AVERAGE="weighted_average",e.SPECIFIC_IDENTIFICATION="specific_identification"}(o||(o={})),function(e){e.IN="in",e.OUT="out",e.ADJUSTMENT="adjustment",e.TRANSFER="transfer"}(c||(c={})),function(e){e.PURCHASE="purchase",e.SALE="sale",e.ADJUSTMENT="adjustment",e.TRANSFER="transfer",e.RETURN="return"}(d||(d={})),function(e){e.CHECKING="checking",e.SAVINGS="savings",e.BUSINESS="business",e.CREDIT_CARD="credit_card"}(u||(u={})),function(e){e.MANUAL="manual",e.FILE_IMPORT="file_import",e.API="api"}(l||(l={})),function(e){e.AUTO="auto",e.MANUAL="manual",e.RULE_BASED="rule_based"}(p||(p={})),function(e){e.AMOUNT_DIFFERENCE="amount_difference",e.MISSING_TRANSACTION="missing_transaction",e.DUPLICATE_TRANSACTION="duplicate_transaction",e.TIMING_DIFFERENCE="timing_difference"}(f||(f={})),function(e){e.MONTHLY="monthly",e.QUARTERLY="quarterly",e.ANNUAL="annual",e.SEMI_ANNUAL="semi_annual"}(A||(A={})),function(e){e.SALES="sales",e.INCOME="income",e.VAT="vat",e.GST="gst",e.WITHHOLDING="withholding",e.PAYROLL="payroll",e.PROPERTY="property"}(m||(m={})),function(e){e.DRAFT="draft",e.READY_TO_FILE="ready_to_file",e.FILED="filed",e.PAID="paid",e.OVERDUE="overdue",e.CANCELLED="cancelled"}(g||(g={})),function(e){e.STRAIGHT_LINE="straight_line",e.DECLINING_BALANCE="declining_balance",e.SUM_OF_YEARS="sum_of_years",e.UNITS_OF_PRODUCTION="units_of_production"}(I||(I={})),function(e){e.ACTIVE="active",e.UNDER_CONSTRUCTION="under_construction",e.DISPOSED="disposed",e.IMPAIRED="impaired",e.RETIRED="retired"}(D||(D={})),function(e){e.PPE="ppe",e.INTANGIBLE="intangible",e.INVESTMENT_PROPERTY="investment_property",e.BIOLOGICAL_ASSETS="biological_assets"}(y||(y={})),function(e){e.FAIR_VALUE_LESS_COSTS="fair_value_less_costs",e.VALUE_IN_USE="value_in_use"}(_||(_={})),function(e){e.SALE="sale",e.SCRAP="scrap",e.TRADE_IN="trade_in",e.DONATION="donation"}(h||(h={}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[1638,6206,7145],()=>a(442));module.exports=i})();