"use strict";(()=>{var e={};e.id=2822,e.ids=[2822],e.modules={8013:e=>{e.exports=require("mongodb")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},3233:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>f,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>A});var r={};a.r(r),a.d(r,{GET:()=>d});var n=a(5419),i=a(9108),o=a(9678),s=a(8070),c=a(3663),u=a(6953);async function d(e){try{let t=e.headers.get("Authorization")?.replace("Bearer ","");if(!t)return s.Z.json({error:"Unauthorized"},{status:401});let a=(0,u.PZ)(t);if(!a)return s.Z.json({error:"Invalid token"},{status:401});let{searchParams:r}=new URL(e.url),n=r.get("asOfDate");if(!n)return s.Z.json({error:"asOfDate parameter is required"},{status:400});let i=await c.d.generateAgedReceivablesReport(a.businessId,new Date(n));return s.Z.json({success:!0,data:i})}catch(e){return console.error("Error generating aged receivables report:",e),s.Z.json({error:"Failed to generate aged receivables report"},{status:500})}}let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/reports/aged-receivables/route",pathname:"/api/reports/aged-receivables",filename:"route",bundlePath:"app/api/reports/aged-receivables/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/reports/aged-receivables/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:m,headerHooks:h,staticGenerationBailout:A}=l,f="/api/reports/aged-receivables/route";function y(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},6953:(e,t,a)=>{a.d(t,{PZ:()=>u,e8:()=>c,sL:()=>d});var r=a(6082),n=a.n(r),i=a(6521),o=a.n(i);let s=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class c{static generateToken(e){let t={userId:e._id,email:e.email,businessId:e.businessId,role:e.role};return n().sign(t,s,{expiresIn:"24h"})}static verifyToken(e){try{return n().verify(e,s)}catch(e){throw Error("Invalid token")}}static async hashPassword(e){return await o().hash(e,12)}static async verifyPassword(e,t){return await o().compare(e,t)}static generateApiKey(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let a=0;a<32;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}}let u=c.verifyToken,d=c.verifyToken},777:(e,t,a)=>{a.r(t),a.d(t,{default:()=>i});var r=a(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let n=process.env.MONGODB_URI,i=new r.MongoClient(n,{}).connect()},3663:(e,t,a)=>{a.d(t,{d:()=>i});var r=a(8013),n=a(777);class i{static getDb(){return n.default.then(e=>e.db("jybek_accounts"))}static async generateCashFlowStatement(e,t){let a=await this.getDb(),n=(await a.collection("accounts").find({businessId:e,type:"asset",$or:[{name:/cash/i},{name:/bank/i},{code:/^1[0-9]/}]}).toArray()).map(e=>e._id.toString()),i=await a.collection("transactions").find({businessId:e,transactionDate:{$gte:t.startDate,$lte:t.endDate}}).toArray(),o=await this.calculateCashBalance(e,t.startDate,n),s=await this.calculateOperatingCashFlows(e,t,i),c=await this.calculateInvestingCashFlows(e,t,i),u=await this.calculateFinancingCashFlows(e,t,i),d=s.reduce((e,t)=>e+t.amount,0)+c.reduce((e,t)=>e+t.amount,0)+u.reduce((e,t)=>e+t.amount,0);return{id:new r.ObjectId().toString(),businessId:e,reportPeriod:t,operatingActivities:s,investingActivities:c,financingActivities:u,netIncreaseInCash:d,cashAtBeginningOfPeriod:o,cashAtEndOfPeriod:o+d,generatedAt:new Date}}static async generateAgedReceivablesReport(e,t){let a=await this.getDb(),n=await a.collection("invoices").find({businessId:e,status:{$in:["sent","partial"]},dueDate:{$lte:t}}).toArray(),i=this.calculateAgingBuckets(n,t),o=n.reduce((e,t)=>e+(t.totalAmount-t.paidAmount),0),s=i.find(e=>"Current"===e.daysRange)?.amount||0;return{id:new r.ObjectId().toString(),businessId:e,asOfDate:t,agingBuckets:i,totalOutstanding:o,currentAmount:s,overdueAmount:o-s}}static async generateAgedPayablesReport(e,t){let a=await this.getDb(),n=await a.collection("bills").find({businessId:e,status:{$in:["open","partial"]},dueDate:{$lte:t}}).toArray(),i=this.calculateAgingBuckets(n,t),o=n.reduce((e,t)=>e+(t.totalAmount-t.paidAmount),0),s=i.find(e=>"Current"===e.daysRange)?.amount||0;return{id:new r.ObjectId().toString(),businessId:e,asOfDate:t,agingBuckets:i,totalOutstanding:o,currentAmount:s,overdueAmount:o-s}}static async generateBudgetVarianceReport(e,t,a){let n=await this.getDb();if(!await n.collection("budgets").findOne({_id:new r.ObjectId(t),businessId:e}))throw Error("Budget not found");let i=await n.collection("budget_lines").find({budgetId:t}).toArray(),o=[],s=0,c=0;for(let t of i){let r=await this.calculateActualAmount(e,t.accountId,a),n=r-t.budgetedAmount,i=t.budgetedAmount>0?n/t.budgetedAmount*100:0,u=n>0?"unfavorable":n<0?"favorable":"neutral";o.push({accountId:t.accountId,accountName:t.accountName||"Unknown Account",budgetedAmount:t.budgetedAmount,actualAmount:r,variance:n,variancePercentage:i,status:u}),s+=t.budgetedAmount,c+=r}let u=c-s,d=s>0?u/s*100:0;return{id:new r.ObjectId().toString(),businessId:e,budgetId:t,reportPeriod:a,budgetedAmount:s,actualAmount:c,variance:u,variancePercentage:d,lineItems:o}}static async generateCustomReport(e,t,a){let n=await this.getDb(),i=await n.collection("report_templates").findOne({_id:new r.ObjectId(t),businessId:e});if(!i)throw Error("Report template not found");let o=await this.executeReportTemplate(i,a),s={businessId:e,templateId:t,reportName:`${i.name} - ${a.dateRange.startDate.toISOString().split("T")[0]}`,reportData:o,parameters:a,generatedAt:new Date};return{id:(await n.collection("generated_reports").insertOne(s)).insertedId.toString(),businessId:e,templateId:t,reportName:s.reportName,reportData:o,parameters:a,generatedAt:s.generatedAt,generatedBy:"system"}}static async getReportTemplates(e){let t=await this.getDb();return(await t.collection("report_templates").find({$or:[{businessId:e},{isSystem:!0}]}).toArray()).map(e=>({id:e._id.toString(),businessId:e.businessId,name:e.name,description:e.description,templateConfig:e.templateConfig,isSystem:e.isSystem,createdAt:e.createdAt}))}static async createReportTemplate(e,t){let a=await this.getDb(),r={...t,createdAt:new Date};return{id:(await a.collection("report_templates").insertOne(r)).insertedId.toString(),businessId:r.businessId,name:r.name,description:r.description,templateConfig:r.templateConfig,isSystem:r.isSystem,createdAt:r.createdAt}}static async calculateCashBalance(e,t,a){let r=await this.getDb(),n=await r.collection("transactions").find({businessId:e,transactionDate:{$lt:t}}).toArray(),i=0;for(let e of n)for(let t of e.lines||[])a.includes(t.accountId)&&(i+=t.debitAmount-t.creditAmount);return i}static async calculateOperatingCashFlows(e,t,a){let r=[];return a.filter(e=>"income"===e.type&&e.transactionDate>=t.startDate&&e.transactionDate<=t.endDate).forEach(e=>{let t=e.lines?.reduce((e,t)=>t.creditAmount>0?e+t.creditAmount:e,0)||0;t>0&&r.push({description:`Customer Receipt - ${e.description}`,amount:t,category:"Cash receipts from customers",accountId:e.lines?.find(e=>e.creditAmount>0)?.accountId,transactionId:e._id.toString()})}),a.filter(e=>"expense"===e.type&&e.transactionDate>=t.startDate&&e.transactionDate<=t.endDate).forEach(e=>{let t=e.lines?.reduce((e,t)=>t.debitAmount>0?e+t.debitAmount:e,0)||0;t>0&&r.push({description:`Supplier Payment - ${e.description}`,amount:-t,category:"Cash payments to suppliers",accountId:e.lines?.find(e=>e.debitAmount>0)?.accountId,transactionId:e._id.toString()})}),r}static async calculateInvestingCashFlows(e,t,a){return[]}static async calculateFinancingCashFlows(e,t,a){return[]}static calculateAgingBuckets(e,t){let a=[{daysRange:"Current",amount:0,count:0,percentage:0},{daysRange:"1-30",amount:0,count:0,percentage:0},{daysRange:"31-60",amount:0,count:0,percentage:0},{daysRange:"61-90",amount:0,count:0,percentage:0},{daysRange:"91+",amount:0,count:0,percentage:0}],r=e.reduce((e,t)=>e+(t.totalAmount-t.paidAmount),0);return e.forEach(e=>{let r=e.totalAmount-e.paidAmount,n=Math.floor((t.getTime()-e.dueDate.getTime())/864e5),i=0;i=n<=0?0:n<=30?1:n<=60?2:n<=90?3:4,a[i].amount+=r,a[i].count+=1}),a.forEach(e=>{e.percentage=r>0?e.amount/r*100:0}),a}static async calculateActualAmount(e,t,a){let r=await this.getDb(),n=await r.collection("transactions").find({businessId:e,transactionDate:{$gte:a.startDate,$lte:a.endDate},"lines.accountId":t}).toArray(),i=0;return n.forEach(e=>{e.lines?.forEach(e=>{e.accountId===t&&(i+=e.debitAmount-e.creditAmount)})}),Math.abs(i)}static async executeReportTemplate(e,t){return{templateName:e.name,parameters:t,data:[],generatedAt:new Date}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,7145],()=>a(3233));module.exports=r})();