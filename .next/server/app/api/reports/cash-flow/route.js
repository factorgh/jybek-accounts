"use strict";(()=>{var t={};t.id=4989,t.ids=[4989],t.modules={8013:t=>{t.exports=require("mongodb")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:t=>{t.exports=require("buffer")},6113:t=>{t.exports=require("crypto")},2781:t=>{t.exports=require("stream")},3837:t=>{t.exports=require("util")},6167:(t,e,a)=>{a.r(e),a.d(e,{headerHooks:()=>h,originalPathname:()=>w,patchFetch:()=>A,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var n={};a.r(n),a.d(n,{GET:()=>d});var r=a(5419),o=a(9108),i=a(9678),s=a(8070),c=a(3663),u=a(6953);async function d(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return s.Z.json({error:"Unauthorized"},{status:401});let a=(0,u.sL)(e);if(!a)return s.Z.json({error:"Invalid token"},{status:401});let{searchParams:n}=new URL(t.url),r=n.get("startDate"),o=n.get("endDate");if(!r||!o)return s.Z.json({error:"startDate and endDate are required"},{status:400});let i={startDate:new Date(r),endDate:new Date(o)},d=await c.d.generateCashFlowStatement(a.businessId,i);return s.Z.json({success:!0,data:d})}catch(t){return console.error("Error generating cash flow report:",t),s.Z.json({error:"Failed to generate cash flow report"},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/reports/cash-flow/route",pathname:"/api/reports/cash-flow",filename:"route",bundlePath:"app/api/reports/cash-flow/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/reports/cash-flow/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:m,headerHooks:h,staticGenerationBailout:f}=l,w="/api/reports/cash-flow/route";function A(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},6953:(t,e,a)=>{a.d(e,{PZ:()=>u,e8:()=>c,sL:()=>d});var n=a(6082),r=a.n(n),o=a(6521),i=a.n(o);let s=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class c{static generateToken(t){let e={userId:t._id,email:t.email,businessId:t.businessId,role:t.role};return r().sign(e,s,{expiresIn:"24h"})}static verifyToken(t){try{return r().verify(t,s)}catch(t){throw Error("Invalid token")}}static async hashPassword(t){return await i().hash(t,12)}static async verifyPassword(t,e){return await i().compare(t,e)}static generateApiKey(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let a=0;a<32;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}}let u=c.verifyToken,d=c.verifyToken},777:(t,e,a)=>{a.r(e),a.d(e,{default:()=>o});var n=a(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let r=process.env.MONGODB_URI,o=new n.MongoClient(r,{}).connect()},3663:(t,e,a)=>{a.d(e,{d:()=>o});var n=a(8013),r=a(777);class o{static getDb(){return r.default.then(t=>t.db("jybek_accounts"))}static async generateCashFlowStatement(t,e){let a=await this.getDb(),r=(await a.collection("accounts").find({businessId:t,type:"asset",$or:[{name:/cash/i},{name:/bank/i},{code:/^1[0-9]/}]}).toArray()).map(t=>t._id.toString()),o=await a.collection("transactions").find({businessId:t,transactionDate:{$gte:e.startDate,$lte:e.endDate}}).toArray(),i=await this.calculateCashBalance(t,e.startDate,r),s=await this.calculateOperatingCashFlows(t,e,o),c=await this.calculateInvestingCashFlows(t,e,o),u=await this.calculateFinancingCashFlows(t,e,o),d=s.reduce((t,e)=>t+e.amount,0)+c.reduce((t,e)=>t+e.amount,0)+u.reduce((t,e)=>t+e.amount,0);return{id:new n.ObjectId().toString(),businessId:t,reportPeriod:e,operatingActivities:s,investingActivities:c,financingActivities:u,netIncreaseInCash:d,cashAtBeginningOfPeriod:i,cashAtEndOfPeriod:i+d,generatedAt:new Date}}static async generateAgedReceivablesReport(t,e){let a=await this.getDb(),r=await a.collection("invoices").find({businessId:t,status:{$in:["sent","partial"]},dueDate:{$lte:e}}).toArray(),o=this.calculateAgingBuckets(r,e),i=r.reduce((t,e)=>t+(e.totalAmount-e.paidAmount),0),s=o.find(t=>"Current"===t.daysRange)?.amount||0;return{id:new n.ObjectId().toString(),businessId:t,asOfDate:e,agingBuckets:o,totalOutstanding:i,currentAmount:s,overdueAmount:i-s}}static async generateAgedPayablesReport(t,e){let a=await this.getDb(),r=await a.collection("bills").find({businessId:t,status:{$in:["open","partial"]},dueDate:{$lte:e}}).toArray(),o=this.calculateAgingBuckets(r,e),i=r.reduce((t,e)=>t+(e.totalAmount-e.paidAmount),0),s=o.find(t=>"Current"===t.daysRange)?.amount||0;return{id:new n.ObjectId().toString(),businessId:t,asOfDate:e,agingBuckets:o,totalOutstanding:i,currentAmount:s,overdueAmount:i-s}}static async generateBudgetVarianceReport(t,e,a){let r=await this.getDb();if(!await r.collection("budgets").findOne({_id:new n.ObjectId(e),businessId:t}))throw Error("Budget not found");let o=await r.collection("budget_lines").find({budgetId:e}).toArray(),i=[],s=0,c=0;for(let e of o){let n=await this.calculateActualAmount(t,e.accountId,a),r=n-e.budgetedAmount,o=e.budgetedAmount>0?r/e.budgetedAmount*100:0,u=r>0?"unfavorable":r<0?"favorable":"neutral";i.push({accountId:e.accountId,accountName:e.accountName||"Unknown Account",budgetedAmount:e.budgetedAmount,actualAmount:n,variance:r,variancePercentage:o,status:u}),s+=e.budgetedAmount,c+=n}let u=c-s,d=s>0?u/s*100:0;return{id:new n.ObjectId().toString(),businessId:t,budgetId:e,reportPeriod:a,budgetedAmount:s,actualAmount:c,variance:u,variancePercentage:d,lineItems:i}}static async generateCustomReport(t,e,a){let r=await this.getDb(),o=await r.collection("report_templates").findOne({_id:new n.ObjectId(e),businessId:t});if(!o)throw Error("Report template not found");let i=await this.executeReportTemplate(o,a),s={businessId:t,templateId:e,reportName:`${o.name} - ${a.dateRange.startDate.toISOString().split("T")[0]}`,reportData:i,parameters:a,generatedAt:new Date};return{id:(await r.collection("generated_reports").insertOne(s)).insertedId.toString(),businessId:t,templateId:e,reportName:s.reportName,reportData:i,parameters:a,generatedAt:s.generatedAt,generatedBy:"system"}}static async getReportTemplates(t){let e=await this.getDb();return(await e.collection("report_templates").find({$or:[{businessId:t},{isSystem:!0}]}).toArray()).map(t=>({id:t._id.toString(),businessId:t.businessId,name:t.name,description:t.description,templateConfig:t.templateConfig,isSystem:t.isSystem,createdAt:t.createdAt}))}static async createReportTemplate(t,e){let a=await this.getDb(),n={...e,createdAt:new Date};return{id:(await a.collection("report_templates").insertOne(n)).insertedId.toString(),businessId:n.businessId,name:n.name,description:n.description,templateConfig:n.templateConfig,isSystem:n.isSystem,createdAt:n.createdAt}}static async calculateCashBalance(t,e,a){let n=await this.getDb(),r=await n.collection("transactions").find({businessId:t,transactionDate:{$lt:e}}).toArray(),o=0;for(let t of r)for(let e of t.lines||[])a.includes(e.accountId)&&(o+=e.debitAmount-e.creditAmount);return o}static async calculateOperatingCashFlows(t,e,a){let n=[];return a.filter(t=>"income"===t.type&&t.transactionDate>=e.startDate&&t.transactionDate<=e.endDate).forEach(t=>{let e=t.lines?.reduce((t,e)=>e.creditAmount>0?t+e.creditAmount:t,0)||0;e>0&&n.push({description:`Customer Receipt - ${t.description}`,amount:e,category:"Cash receipts from customers",accountId:t.lines?.find(t=>t.creditAmount>0)?.accountId,transactionId:t._id.toString()})}),a.filter(t=>"expense"===t.type&&t.transactionDate>=e.startDate&&t.transactionDate<=e.endDate).forEach(t=>{let e=t.lines?.reduce((t,e)=>e.debitAmount>0?t+e.debitAmount:t,0)||0;e>0&&n.push({description:`Supplier Payment - ${t.description}`,amount:-e,category:"Cash payments to suppliers",accountId:t.lines?.find(t=>t.debitAmount>0)?.accountId,transactionId:t._id.toString()})}),n}static async calculateInvestingCashFlows(t,e,a){return[]}static async calculateFinancingCashFlows(t,e,a){return[]}static calculateAgingBuckets(t,e){let a=[{daysRange:"Current",amount:0,count:0,percentage:0},{daysRange:"1-30",amount:0,count:0,percentage:0},{daysRange:"31-60",amount:0,count:0,percentage:0},{daysRange:"61-90",amount:0,count:0,percentage:0},{daysRange:"91+",amount:0,count:0,percentage:0}],n=t.reduce((t,e)=>t+(e.totalAmount-e.paidAmount),0);return t.forEach(t=>{let n=t.totalAmount-t.paidAmount,r=Math.floor((e.getTime()-t.dueDate.getTime())/864e5),o=0;o=r<=0?0:r<=30?1:r<=60?2:r<=90?3:4,a[o].amount+=n,a[o].count+=1}),a.forEach(t=>{t.percentage=n>0?t.amount/n*100:0}),a}static async calculateActualAmount(t,e,a){let n=await this.getDb(),r=await n.collection("transactions").find({businessId:t,transactionDate:{$gte:a.startDate,$lte:a.endDate},"lines.accountId":e}).toArray(),o=0;return r.forEach(t=>{t.lines?.forEach(t=>{t.accountId===e&&(o+=t.debitAmount-t.creditAmount)})}),Math.abs(o)}static async executeReportTemplate(t,e){return{templateName:t.name,parameters:e,data:[],generatedAt:new Date}}}}};var e=require("../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),n=e.X(0,[1638,6206,7145],()=>a(6167));module.exports=n})();