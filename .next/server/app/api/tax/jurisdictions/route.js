"use strict";(()=>{var t={};t.id=1751,t.ids=[1751],t.modules={8013:t=>{t.exports=require("mongodb")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:t=>{t.exports=require("buffer")},6113:t=>{t.exports=require("crypto")},2781:t=>{t.exports=require("stream")},3837:t=>{t.exports=require("util")},791:(t,e,a)=>{a.r(e),a.d(e,{headerHooks:()=>x,originalPathname:()=>m,patchFetch:()=>_,requestAsyncStorage:()=>I,routeModule:()=>f,serverHooks:()=>g,staticGenerationAsyncStorage:()=>T,staticGenerationBailout:()=>y});var i={};a.r(i),a.d(i,{GET:()=>p,POST:()=>D});var r=a(5419),n=a(9108),d=a(9678),s=a(8070),o=a(8013),c=a(777),u=a(739);class l{static getDb(){return c.default.then(t=>t.db("jybek_accounts"))}static async createTaxJurisdiction(t){let e=await this.getDb(),a={...t,createdAt:new Date,updatedAt:new Date};return{id:(await e.collection("tax_jurisdictions").insertOne(a)).insertedId.toString(),jurisdictionCode:a.jurisdictionCode,jurisdictionName:a.jurisdictionName,taxAuthority:a.taxAuthority,filingFrequency:a.filingFrequency,isActive:a.isActive,createdAt:a.createdAt,updatedAt:a.updatedAt}}static async getTaxJurisdictions(){let t=await this.getDb();return(await t.collection("tax_jurisdictions").find({isActive:!0}).sort({jurisdictionName:1}).toArray()).map(t=>({id:t._id.toString(),jurisdictionCode:t.jurisdictionCode,jurisdictionName:t.jurisdictionName,taxAuthority:t.taxAuthority,filingFrequency:t.filingFrequency,isActive:t.isActive,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async createTaxRate(t,e){let a=await this.getDb(),i={...e,jurisdictionId:t,createdAt:new Date,updatedAt:new Date};return{id:(await a.collection("tax_rates").insertOne(i)).insertedId.toString(),jurisdictionId:i.jurisdictionId,taxType:i.taxType,ratePercentage:i.ratePercentage,effectiveDate:i.effectiveDate,expiryDate:i.expiryDate,description:i.description,isActive:i.isActive,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async getTaxRates(t){let e=await this.getDb(),a={isActive:!0};return t&&(a.jurisdictionId=t),(await e.collection("tax_rates").find(a).sort({effectiveDate:-1}).toArray()).map(t=>({id:t._id.toString(),jurisdictionId:t.jurisdictionId,taxType:t.taxType,ratePercentage:t.ratePercentage,effectiveDate:t.effectiveDate,expiryDate:t.expiryDate,description:t.description,isActive:t.isActive,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async createTaxCode(t,e){let a=await this.getDb(),i={...e,businessId:t,createdAt:new Date,updatedAt:new Date};return{id:(await a.collection("tax_codes").insertOne(i)).insertedId.toString(),businessId:i.businessId,code:i.code,description:i.description,taxRateId:i.taxRateId,isRecoverable:i.isRecoverable,glAccountId:i.glAccountId,isActive:i.isActive,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async getTaxCodes(t){let e=await this.getDb();return(await e.collection("tax_codes").find({businessId:t,isActive:!0}).sort({code:1}).toArray()).map(t=>({id:t._id.toString(),businessId:t.businessId,code:t.code,description:t.description,taxRateId:t.taxRateId,isRecoverable:t.isRecoverable,glAccountId:t.glAccountId,isActive:t.isActive,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async calculateTax(t,e){let a=await this.getDb(),i=await a.collection("tax_codes").findOne({_id:new o.ObjectId(e.taxCodeId),businessId:t,isActive:!0});if(!i)throw Error("Tax code not found");let r=await a.collection("tax_rates").findOne({_id:new o.ObjectId(i.taxRateId),isActive:!0,effectiveDate:{$lte:e.transactionDate},$or:[{expiryDate:{$gte:e.transactionDate}},{expiryDate:{$exists:!1}}]});if(!r)throw Error("Tax rate not found for the specified date");let n=e.amount*(r.ratePercentage/100),d=[{taxType:r.taxType,jurisdictionId:r.jurisdictionId,rate:r.ratePercentage,amount:n,isRecoverable:i.isRecoverable}];return{taxableAmount:e.amount,taxAmount:n,taxBreakdown:d,totalTax:n}}static async createTaxReturn(t,e){let a=await this.getDb(),i={...e,businessId:t,createdAt:new Date,updatedAt:new Date};return{id:(await a.collection("tax_returns").insertOne(i)).insertedId.toString(),businessId:i.businessId,jurisdictionId:i.jurisdictionId,returnPeriod:i.returnPeriod,periodStartDate:i.periodStartDate,periodEndDate:i.periodEndDate,totalTaxableAmount:i.totalTaxableAmount,totalTaxAmount:i.totalTaxAmount,status:i.status,dueDate:i.dueDate,filedDate:i.filedDate,paidDate:i.paidDate,filingReference:i.filingReference,createdAt:i.createdAt,updatedAt:i.updatedAt}}static async getTaxReturns(t,e,a){let i=await this.getDb(),r={businessId:t};return e&&(r.jurisdictionId=e),a&&(r.status=a),(await i.collection("tax_returns").find(r).sort({periodEndDate:-1}).toArray()).map(t=>({id:t._id.toString(),businessId:t.businessId,jurisdictionId:t.jurisdictionId,returnPeriod:t.returnPeriod,periodStartDate:t.periodStartDate,periodEndDate:t.periodEndDate,totalTaxableAmount:t.totalTaxableAmount,totalTaxAmount:t.totalTaxAmount,status:t.status,dueDate:t.dueDate,filedDate:t.filedDate,paidDate:t.paidDate,filingReference:t.filingReference,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async processTaxPayment(t,e){let a=await this.getDb(),i={...e,businessId:t,createdAt:new Date},r=await a.collection("tax_payments").insertOne(i);if(i.taxReturnId&&await a.collection("tax_returns").updateOne({_id:new o.ObjectId(i.taxReturnId)},{$set:{status:u.dm.PAID,paidDate:i.paymentDate,updatedAt:new Date}}),e.taxReturnId){let i=await a.collection("tax_returns").findOne({_id:new o.ObjectId(e.taxReturnId)});i&&await a.collection("tax_liabilities").updateOne({businessId:t,taxType:"sales",jurisdictionId:i.jurisdictionId,dueDate:i.dueDate,isPaid:!1},{$set:{isPaid:!0,paidAmount:e.paymentAmount,updatedAt:new Date}})}return{id:r.insertedId.toString(),businessId:i.businessId,taxReturnId:i.taxReturnId,paymentAmount:i.paymentAmount,paymentDate:i.paymentDate,paymentMethod:i.paymentMethod,paymentReference:i.paymentReference,notes:i.notes,createdAt:i.createdAt}}static async getTaxLiabilities(t){let e=await this.getDb();return(await e.collection("tax_liabilities").find({businessId:t}).sort({dueDate:1}).toArray()).map(t=>({id:t._id.toString(),businessId:t.businessId,taxType:t.taxType,jurisdictionId:t.jurisdictionId,liabilityAmount:t.liabilityAmount,dueDate:t.dueDate,isPaid:t.isPaid,paidAmount:t.paidAmount,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async generateTaxReturn(t,e,a){let i=await this.getDb(),r=await i.collection("transactions").find({businessId:t,transactionDate:{$gte:a.startDate,$lte:a.endDate}}).toArray(),n=0,d=0;for(let t of r)if("income"===t.type){let a=t.lines?.reduce((t,e)=>e.creditAmount>0?t+e.creditAmount:t,0)||0;n+=a;let i=await this.getApplicableTaxRate(e,u.E_.SALES,t.transactionDate);i&&(d+=i.ratePercentage/100*a)}let s=await i.collection("tax_jurisdictions").findOne({_id:new o.ObjectId(e)});if(!s)throw Error("Tax jurisdiction not found");let c=this.calculateDueDate(a.endDate,s.filingFrequency),l=this.formatReturnPeriod(a,s.filingFrequency);return await this.createTaxReturn(t,{jurisdictionId:e,returnPeriod:l,periodStartDate:a.startDate,periodEndDate:a.endDate,totalTaxableAmount:n,totalTaxAmount:d,status:u.dm.DRAFT,dueDate:c})}static async getApplicableTaxRate(t,e,a){let i=await this.getDb(),r=await i.collection("tax_rates").findOne({jurisdictionId:t,taxType:e,isActive:!0,effectiveDate:{$lte:a},$or:[{expiryDate:{$gte:a}},{expiryDate:{$exists:!1}}]});return r?{id:r._id.toString(),jurisdictionId:r.jurisdictionId,taxType:r.taxType,ratePercentage:r.ratePercentage,effectiveDate:r.effectiveDate,expiryDate:r.expiryDate,description:r.description,isActive:r.isActive,createdAt:r.createdAt,updatedAt:r.updatedAt}:null}static calculateDueDate(t,e){let a=new Date(t);switch(e){case u.Xy.MONTHLY:a.setDate(a.getDate()+20);break;case u.Xy.QUARTERLY:a.setMonth(a.getMonth()+1),a.setDate(a.getDate()+20);break;case u.Xy.ANNUAL:a.setMonth(a.getMonth()+3),a.setDate(a.getDate()+15);break;case u.Xy.SEMI_ANNUAL:a.setMonth(a.getMonth()+2),a.setDate(a.getDate()+20)}return a}static formatReturnPeriod(t,e){let a=t.startDate;switch(t.endDate,e){case u.Xy.MONTHLY:return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`;case u.Xy.QUARTERLY:let i=Math.floor(a.getMonth()/3)+1;return`${a.getFullYear()}-Q${i}`;case u.Xy.ANNUAL:return`${a.getFullYear()}`;case u.Xy.SEMI_ANNUAL:let r=6>a.getMonth()?"H1":"H2";return`${a.getFullYear()}-${r}`;default:return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`}}static async getTaxSummary(t){let e=await this.getDb(),a=await e.collection("tax_liabilities").find({businessId:t,isPaid:!1}).toArray(),i=a.reduce((t,e)=>t+e.liabilityAmount,0),r=a.filter(t=>new Date>t.dueDate).reduce((t,e)=>t+e.liabilityAmount,0),n=await e.collection("tax_returns").find({businessId:t}).sort({periodEndDate:-1}).limit(5).toArray(),d=a.filter(t=>new Date<=t.dueDate&&!t.isPaid).sort((t,e)=>new Date(t.dueDate).getTime()-new Date(e.dueDate).getTime()).slice(0,3);return{totalLiabilities:i,overdueLiabilities:r,pendingReturns:n.filter(t=>"draft"===t.status).length,upcomingDue:d.map(t=>({id:t._id.toString(),taxType:t.taxType,amount:t.liabilityAmount,dueDate:t.dueDate,daysUntilDue:Math.ceil((new Date(t.dueDate).getTime()-new Date().getTime())/864e5)})),recentReturns:n.map(t=>({id:t._id.toString(),jurisdictionId:t.jurisdictionId,returnPeriod:t.returnPeriod,totalTaxAmount:t.totalTaxAmount,status:t.status,dueDate:t.dueDate}))}}static async fileTaxReturn(t,e,a){let i=await this.getDb();await i.collection("tax_returns").updateOne({_id:new o.ObjectId(e),businessId:t},{$set:{status:u.dm.FILED,filedDate:new Date,filingReference:a,updatedAt:new Date}});let r=await i.collection("tax_returns").findOne({_id:new o.ObjectId(e)});if(!r)throw Error("Tax return not found");return{id:r._id.toString(),businessId:r.businessId,jurisdictionId:r.jurisdictionId,returnPeriod:r.returnPeriod,periodStartDate:r.periodStartDate,periodEndDate:r.periodEndDate,totalTaxableAmount:r.totalTaxableAmount,totalTaxAmount:r.totalTaxAmount,status:r.status,dueDate:r.dueDate,filedDate:r.filedDate,paidDate:r.paidDate,filingReference:r.filingReference,createdAt:r.createdAt,updatedAt:r.updatedAt}}}var A=a(6953);async function p(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return s.Z.json({error:"Unauthorized"},{status:401});if(!(0,A.PZ)(e))return s.Z.json({error:"Invalid token"},{status:401});let a=await l.getTaxJurisdictions();return s.Z.json({success:!0,data:a})}catch(t){return console.error("Error fetching tax jurisdictions:",t),s.Z.json({error:"Failed to fetch tax jurisdictions"},{status:500})}}async function D(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return s.Z.json({error:"Unauthorized"},{status:401});if(!(0,A.PZ)(e))return s.Z.json({error:"Invalid token"},{status:401});let a=await t.json(),i=await l.createTaxJurisdiction(a);return s.Z.json({success:!0,data:i})}catch(t){return console.error("Error creating tax jurisdiction:",t),s.Z.json({error:"Failed to create tax jurisdiction"},{status:500})}}let f=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/tax/jurisdictions/route",pathname:"/api/tax/jurisdictions",filename:"route",bundlePath:"app/api/tax/jurisdictions/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/tax/jurisdictions/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:I,staticGenerationAsyncStorage:T,serverHooks:g,headerHooks:x,staticGenerationBailout:y}=f,m="/api/tax/jurisdictions/route";function _(){return(0,d.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:T})}},6953:(t,e,a)=>{a.d(e,{PZ:()=>c,e8:()=>o,sL:()=>u});var i=a(6082),r=a.n(i),n=a(6521),d=a.n(n);let s=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class o{static generateToken(t){let e={userId:t._id,email:t.email,businessId:t.businessId,role:t.role};return r().sign(e,s,{expiresIn:"24h"})}static verifyToken(t){try{return r().verify(t,s)}catch(t){throw Error("Invalid token")}}static async hashPassword(t){return await d().hash(t,12)}static async verifyPassword(t,e){return await d().compare(t,e)}static generateApiKey(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let a=0;a<32;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}}let c=o.verifyToken,u=o.verifyToken},777:(t,e,a)=>{a.r(e),a.d(e,{default:()=>n});var i=a(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let r=process.env.MONGODB_URI,n=new i.MongoClient(r,{}).connect()},739:(t,e,a)=>{var i,r,n,d,s,o,c,u,l,A,p,D,f,I,T,g,x,y,m;a.d(e,{E_:()=>f,UW:()=>o,Xy:()=>D,_q:()=>A,dm:()=>I,eR:()=>s,l5:()=>g,sA:()=>T,z1:()=>p}),function(t){t.ANNUAL="annual",t.QUARTERLY="quarterly",t.MONTHLY="monthly",t.PROJECT="project"}(i||(i={})),function(t){t.DRAFT="draft",t.SUBMITTED="submitted",t.APPROVED="approved",t.REJECTED="rejected",t.ARCHIVED="archived"}(r||(r={})),function(t){t.MONTHLY="monthly",t.QUARTERLY="quarterly",t.ANNUAL="annual"}(n||(n={})),function(t){t.OPTIMISTIC="optimistic",t.PESSIMISTIC="pessimistic",t.REALISTIC="realistic",t.CUSTOM="custom"}(d||(d={})),function(t){t.FIFO="fifo",t.LIFO="lifo",t.WEIGHTED_AVERAGE="weighted_average",t.SPECIFIC_IDENTIFICATION="specific_identification"}(s||(s={})),function(t){t.IN="in",t.OUT="out",t.ADJUSTMENT="adjustment",t.TRANSFER="transfer"}(o||(o={})),function(t){t.PURCHASE="purchase",t.SALE="sale",t.ADJUSTMENT="adjustment",t.TRANSFER="transfer",t.RETURN="return"}(c||(c={})),function(t){t.CHECKING="checking",t.SAVINGS="savings",t.BUSINESS="business",t.CREDIT_CARD="credit_card"}(u||(u={})),function(t){t.MANUAL="manual",t.FILE_IMPORT="file_import",t.API="api"}(l||(l={})),function(t){t.AUTO="auto",t.MANUAL="manual",t.RULE_BASED="rule_based"}(A||(A={})),function(t){t.AMOUNT_DIFFERENCE="amount_difference",t.MISSING_TRANSACTION="missing_transaction",t.DUPLICATE_TRANSACTION="duplicate_transaction",t.TIMING_DIFFERENCE="timing_difference"}(p||(p={})),function(t){t.MONTHLY="monthly",t.QUARTERLY="quarterly",t.ANNUAL="annual",t.SEMI_ANNUAL="semi_annual"}(D||(D={})),function(t){t.SALES="sales",t.INCOME="income",t.VAT="vat",t.GST="gst",t.WITHHOLDING="withholding",t.PAYROLL="payroll",t.PROPERTY="property"}(f||(f={})),function(t){t.DRAFT="draft",t.READY_TO_FILE="ready_to_file",t.FILED="filed",t.PAID="paid",t.OVERDUE="overdue",t.CANCELLED="cancelled"}(I||(I={})),function(t){t.STRAIGHT_LINE="straight_line",t.DECLINING_BALANCE="declining_balance",t.SUM_OF_YEARS="sum_of_years",t.UNITS_OF_PRODUCTION="units_of_production"}(T||(T={})),function(t){t.ACTIVE="active",t.UNDER_CONSTRUCTION="under_construction",t.DISPOSED="disposed",t.IMPAIRED="impaired",t.RETIRED="retired"}(g||(g={})),function(t){t.PPE="ppe",t.INTANGIBLE="intangible",t.INVESTMENT_PROPERTY="investment_property",t.BIOLOGICAL_ASSETS="biological_assets"}(x||(x={})),function(t){t.FAIR_VALUE_LESS_COSTS="fair_value_less_costs",t.VALUE_IN_USE="value_in_use"}(y||(y={})),function(t){t.SALE="sale",t.SCRAP="scrap",t.TRADE_IN="trade_in",t.DONATION="donation"}(m||(m={}))}};var e=require("../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),i=e.X(0,[1638,6206,7145],()=>a(791));module.exports=i})();