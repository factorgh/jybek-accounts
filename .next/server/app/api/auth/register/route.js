"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={8013:e=>{e.exports=require("mongodb")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},1075:(e,t,n)=>{n.r(t),n.d(t,{headerHooks:()=>b,originalPathname:()=>g,patchFetch:()=>A,requestAsyncStorage:()=>w,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>v});var a={};n.r(a),n.d(a,{POST:()=>y});var i=n(5419),s=n(9108),r=n(9678),c=n(8070),o=n(777),d=n(6953),u=n(8013);class l{static getDb(){return o.default.then(e=>e.db("jybek_accounts"))}static async createBusiness(e){let t=await this.getDb(),n={...e,createdAt:new Date,updatedAt:new Date},a=await t.collection("businesses").insertOne(n);return{...n,_id:a.insertedId.toString()}}static async getBusinessById(e){let t=await this.getDb();return await t.collection("businesses").findOne({_id:new u.ObjectId(e)})}static async updateBusiness(e,t){let n=await this.getDb(),a={...t,updatedAt:new Date};return(await n.collection("businesses").findOneAndUpdate({_id:new u.ObjectId(e)},{$set:a},{returnDocument:"after"})).value||null}static async deleteBusiness(e){let t=await this.getDb();return(await t.collection("businesses").deleteOne({_id:new u.ObjectId(e)})).deletedCount>0}}var p=n(1023);async function y(e){try{let{email:t,password:a,name:i,businessName:s,fiscalYearStart:r,openingBalance:u}=await e.json();if(!t||!a||!i||!s)return c.Z.json({error:"Missing required fields"},{status:400});let y=await o.default.then(e=>e.db("jybek_accounts"));if(await y.collection("users").findOne({email:t}))return c.Z.json({error:"User already exists"},{status:400});let m=await d.e8.hashPassword(a),w={name:s,email:t,fiscalYearStart:new Date(r),openingBalance:u||0},h=await l.createBusiness(w),f={email:t,name:i,businessId:h._id,role:"admin",password:m,createdAt:new Date,updatedAt:new Date},b=await y.collection("users").insertOne(f),v={...f,_id:b.insertedId.toString()};if(await p.B.seedDefaultAccounts(h._id),u&&u>0){let{LedgerService:e}=await n.e(9962).then(n.bind(n,9962)),t=await p.B.getAccountsByBusiness(h._id),a=t.find(e=>"1000"===e.code),i=t.find(e=>"3000"===e.code);a&&i&&await e.postOpeningBalance(h._id,u,i._id,a._id,new Date,v._id)}let g=d.e8.generateToken(v);return c.Z.json({message:"User registered successfully",user:{id:v._id,email:v.email,name:v.name,businessId:v.businessId,role:v.role},token:g})}catch(e){return console.error("Registration error:",e),c.Z.json({error:"Internal server error"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/auth/register/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:f,headerHooks:b,staticGenerationBailout:v}=m,g="/api/auth/register/route";function A(){return(0,r.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},6953:(e,t,n)=>{n.d(t,{PZ:()=>d,e8:()=>o,sL:()=>u});var a=n(6082),i=n.n(a),s=n(6521),r=n.n(s);let c=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class o{static generateToken(e){let t={userId:e._id,email:e.email,businessId:e.businessId,role:e.role};return i().sign(t,c,{expiresIn:"24h"})}static verifyToken(e){try{return i().verify(e,c)}catch(e){throw Error("Invalid token")}}static async hashPassword(e){return await r().hash(e,12)}static async verifyPassword(e,t){return await r().compare(e,t)}static generateApiKey(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let n=0;n<32;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}}let d=o.verifyToken,u=o.verifyToken},777:(e,t,n)=>{n.r(t),n.d(t,{default:()=>s});var a=n(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let i=process.env.MONGODB_URI,s=new a.MongoClient(i,{}).connect()},1023:(e,t,n)=>{n.d(t,{B:()=>r});var a=n(8013),i=n(777),s=n(5200);class r{static getDb(){return i.default.then(e=>e.db("jybek_accounts"))}static async createAccount(e){let t=await this.getDb(),n={...e,balance:e.balance||0,createdAt:new Date,updatedAt:new Date},a=await t.collection("accounts").insertOne(n);return{...n,_id:a.insertedId.toString()}}static async getAccountsByBusiness(e){let t=await this.getDb();return await t.collection("accounts").find({businessId:e}).sort({code:1}).toArray()}static async getAccountById(e){let t=await this.getDb();return await t.collection("accounts").findOne({_id:new a.ObjectId(e)})}static async updateAccount(e,t){let n=await this.getDb(),i={...t,updatedAt:new Date};return(await n.collection("accounts").findOneAndUpdate({_id:new a.ObjectId(e)},{$set:i},{returnDocument:"after"})).value||null}static async deleteAccount(e){let t=await this.getDb();return(await t.collection("accounts").deleteOne({_id:new a.ObjectId(e)})).deletedCount>0}static async seedDefaultAccounts(e){let t=[{code:"1000",name:"Cash",type:s.Qm.Asset,isActive:!0},{code:"1100",name:"Bank Account",type:s.Qm.Asset,isActive:!0},{code:"1200",name:"Accounts Receivable",type:s.Qm.Asset,isActive:!0},{code:"2000",name:"Accounts Payable",type:s.Qm.Liability,isActive:!0},{code:"3000",name:"Owner's Capital",type:s.Qm.Equity,isActive:!0},{code:"4000",name:"Sales Revenue",type:s.Qm.Income,isActive:!0},{code:"4100",name:"Service Income",type:s.Qm.Income,isActive:!0},{code:"5000",name:"Rent Expense",type:s.Qm.Expense,isActive:!0},{code:"5100",name:"Utilities Expense",type:s.Qm.Expense,isActive:!0},{code:"5200",name:"Transport Expense",type:s.Qm.Expense,isActive:!0},{code:"5300",name:"Office Supplies",type:s.Qm.Expense,isActive:!0}],n=[];for(let a of t){let t=await this.createAccount({businessId:e,...a,balance:0});n.push(t)}return n}}},5200:(e,t,n)=>{var a,i,s,r,c,o,d,u;n.d(t,{Qm:()=>a,iU:()=>i}),function(e){e.Asset="asset",e.Liability="liability",e.Equity="equity",e.Income="income",e.Expense="expense"}(a||(a={})),function(e){e.ManualJournal="manual_journal",e.Income="income",e.Expense="expense",e.Invoice="invoice",e.InvoicePayment="invoice_payment",e.OpeningBalance="opening_balance"}(i||(i={})),function(e){e.Draft="draft",e.Sent="sent",e.Paid="paid",e.Cancelled="cancelled"}(s||(s={})),function(e){e.Draft="draft",e.Sent="sent",e.Accepted="accepted",e.Rejected="rejected",e.Expired="expired",e.ConvertedToInvoice="converted_to_invoice"}(r||(r={})),function(e){e.Daily="daily",e.Weekly="weekly",e.BiWeekly="bi_weekly",e.Monthly="monthly",e.Quarterly="quarterly",e.Annually="annually"}(c||(c={})),function(e){e.Draft="draft",e.InProgress="in_progress",e.Completed="completed",e.Cancelled="cancelled"}(o||(o={})),function(e){e.Unmatched="unmatched",e.Matched="matched",e.Reconciled="reconciled",e.Excluded="excluded"}(d||(d={})),function(e){e.Deposit="deposit",e.Withdrawal="withdrawal",e.Check="check",e.Transfer="transfer",e.BankCharge="bank_charge",e.Interest="interest",e.Other="other"}(u||(u={}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[1638,6206,7145],()=>n(1075));module.exports=a})();