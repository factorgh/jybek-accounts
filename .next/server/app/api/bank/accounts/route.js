"use strict";(()=>{var t={};t.id=7757,t.ids=[7757],t.modules={8013:t=>{t.exports=require("mongodb")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:t=>{t.exports=require("buffer")},6113:t=>{t.exports=require("crypto")},2781:t=>{t.exports=require("stream")},3837:t=>{t.exports=require("util")},5463:(t,e,a)=>{a.r(e),a.d(e,{headerHooks:()=>_,originalPathname:()=>D,patchFetch:()=>y,requestAsyncStorage:()=>I,routeModule:()=>p,serverHooks:()=>T,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>g});var n={};a.r(n),a.d(n,{GET:()=>A,POST:()=>h});var i=a(5419),r=a(9108),c=a(9678),o=a(8070),s=a(8013),u=a(777),l=a(739);class d{static getDb(){return u.default.then(t=>t.db("jybek_accounts"))}static async createBankAccount(t,e){let a=await this.getDb(),n={...e,createdAt:new Date,updatedAt:new Date};return{id:(await a.collection("bank_accounts").insertOne(n)).insertedId.toString(),businessId:n.businessId,accountName:n.accountName,accountNumber:n.accountNumber,bankName:n.bankName,accountType:n.accountType,currency:n.currency,isActive:n.isActive,lastReconciliationDate:n.lastReconciliationDate,createdAt:n.createdAt}}static async getBankAccounts(t){let e=await this.getDb();return(await e.collection("bank_accounts").find({businessId:t,isActive:!0}).sort({accountName:1}).toArray()).map(t=>({id:t._id.toString(),businessId:t.businessId,accountName:t.accountName,accountNumber:t.accountNumber,bankName:t.bankName,accountType:t.accountType,currency:t.currency,isActive:t.isActive,lastReconciliationDate:t.lastReconciliationDate,createdAt:t.createdAt,updatedAt:t.updatedAt}))}static async importBankStatement(t,e,a){let n=await this.getDb(),i={...a,importedAt:new Date};return{id:(await n.collection("bank_statements").insertOne(i)).insertedId.toString(),bankAccountId:i.bankAccountId,statementDate:i.statementDate,openingBalance:i.openingBalance,closingBalance:i.closingBalance,statementLines:i.statementLines,importSource:i.importSource,importedAt:i.importedAt}}static async autoMatchTransactions(t,e){let a=await this.getDb(),n=await a.collection("bank_statements").findOne({_id:new s.ObjectId(e)});if(!n)throw Error("Bank statement not found");let i=await a.collection("reconciliation_rules").find({businessId:t,isActive:!0}).sort({priority:-1}).toArray(),r=await a.collection("transactions").find({businessId:t}).toArray(),c=[];return n.statementLines.forEach((t,a)=>{let n=null,o=0;for(let e of i){let a=this.applyReconciliationRule(t,r,e);a&&a.confidence>o&&(n=a,o=a.confidence)}n||(n=this.performFuzzyMatching(t,r)),n&&o>=.7&&c.push({id:new s.ObjectId().toString(),statementId:e,statementLineId:t.id,transactionId:n.transactionId,matchType:n.ruleBased?l._q.RULE_BASED:l._q.AUTO,confidenceScore:o,matchedBy:"system",matchedAt:new Date,notes:n.notes})}),c.length>0&&await a.collection("reconciliation_matches").insertMany(c),c}static async createManualMatch(t,e,a,n,i){let r=await this.getDb(),c={statementId:e,statementLineId:a,transactionId:n,matchType:l._q.MANUAL,confidenceScore:1,matchedBy:"user",matchedAt:new Date,notes:i};return{id:(await r.collection("reconciliation_matches").insertOne(c)).insertedId.toString(),statementId:c.statementId,statementLineId:c.statementLineId,transactionId:c.transactionId,matchType:c.matchType,confidenceScore:c.confidenceScore,matchedBy:c.matchedBy,matchedAt:c.matchedAt,notes:c.notes}}static async performReconciliation(t,e,a){let n=await this.getDb(),i=await n.collection("bank_statements").findOne({_id:new s.ObjectId(a),bankAccountId:e});if(!i)throw Error("Bank statement not found");let r=await n.collection("reconciliation_matches").find({statementId:a}).toArray(),c=i.statementLines.length,o=r.length,u=i.statementLines.reduce((t,e)=>t+e.amount,0),d=r.reduce((t,e)=>t+i.statementLines[e.statementLineId].amount,0),m=[];return i.statementLines.forEach((t,e)=>{r.some(t=>t.statementLineId===e)||m.push({id:new s.ObjectId().toString(),reconciliationId:a,varianceType:l.z1.MISSING_TRANSACTION,amount:t.amount,description:`Unmatched transaction: ${t.description}`,resolved:!1})}),m.length>0&&await n.collection("reconciliation_variances").insertMany(m),await n.collection("bank_accounts").updateOne({_id:new s.ObjectId(e)},{$set:{lastReconciliationDate:i.statementDate,updatedAt:new Date}}),{statementId:a,bankAccountId:e,totalStatementLines:c,matchedLines:o,unmatchedLines:c-o,totalStatementAmount:u,matchedAmount:d,unmatchedAmount:u-d,matchPercentage:c>0?o/c*100:0,variances:m.length}}static async createReconciliationRule(t,e){let a=await this.getDb(),n={...e,createdAt:new Date,updatedAt:new Date};return{id:(await a.collection("reconciliation_rules").insertOne(n)).insertedId.toString(),businessId:n.businessId,ruleName:n.ruleName,ruleConditions:n.ruleConditions,matchCriteria:n.matchCriteria,priority:n.priority,isActive:n.isActive,createdAt:n.createdAt}}static async getReconciliationMatches(t){let e=await this.getDb();return(await e.collection("reconciliation_matches").find({statementId:t}).sort({matchedAt:-1}).toArray()).map(t=>({id:t._id.toString(),statementId:t.statementId,statementLineId:t.statementLineId,transactionId:t.transactionId,matchType:t.matchType,confidenceScore:t.confidenceScore,matchedBy:t.matchedBy,matchedAt:t.matchedAt,notes:t.notes}))}static async getReconciliationVariances(t){let e=await this.getDb(),a={};return t&&(a.reconciliationId=t),(await e.collection("reconciliation_variances").find(a).sort({createdAt:-1}).toArray()).map(t=>({id:t._id.toString(),reconciliationId:t.reconciliationId,varianceType:t.varianceType,amount:t.amount,description:t.description,resolved:t.resolved,resolvedAt:t.resolvedAt,resolvedBy:t.resolvedBy,resolutionNotes:t.resolutionNotes}))}static applyReconciliationRule(t,e,a){let n=e.filter(e=>this.evaluateRuleConditions(t,e,a.ruleConditions));if(0===n.length)return null;let i=.5,r=n[0];if(a.matchCriteria.amountTolerance){let e=a.matchCriteria.amountTolerance;r=n.reduce((e,a)=>Math.abs(t.amount-this.getTransactionAmount(a))<Math.abs(t.amount-this.getTransactionAmount(e))?a:e,r),Math.abs(t.amount-this.getTransactionAmount(r))<=e&&(i+=.3)}if(a.matchCriteria.dateTolerance){let e=864e5*a.matchCriteria.dateTolerance;Math.abs(new Date(t.transactionDate).getTime()-new Date(r.transactionDate).getTime())<=e&&(i+=.2)}return{transactionId:r._id.toString(),confidence:Math.min(i,1),ruleBased:!0,notes:`Matched using rule: ${a.ruleName}`}}static performFuzzyMatching(t,e){let a=e.filter(e=>{let a=Math.abs(t.amount-this.getTransactionAmount(e)),n=Math.abs(new Date(t.transactionDate).getTime()-new Date(e.transactionDate).getTime());return 0===a&&n<=6048e5});return 0===a.length?null:{transactionId:a.reduce((e,a)=>Math.abs(new Date(t.transactionDate).getTime()-new Date(a.transactionDate).getTime())<Math.abs(new Date(t.transactionDate).getTime()-new Date(e.transactionDate).getTime())?a:e)._id.toString(),confidence:.8,ruleBased:!1,notes:"Auto-matched based on amount and date"}}static evaluateRuleConditions(t,e,a){return a.every(a=>{switch(a.field){case"amount":return this.evaluateAmountCondition(t.amount,e,a);case"description":return this.evaluateDescriptionCondition(t.description,e,a);case"date":return this.evaluateDateCondition(t.transactionDate,e,a);default:return!1}})}static evaluateAmountCondition(t,e,a){let n=this.getTransactionAmount(e);switch(a.operator){case"equals":return t===n;case"greater_than":return t>n;case"less_than":return t<n;case"between":return t>=a.value[0]&&t<=a.value[1];default:return!1}}static evaluateDescriptionCondition(t,e,a){let n=e.description||"";switch(a.operator){case"contains":return t.toLowerCase().includes(a.value.toLowerCase())||n.toLowerCase().includes(a.value.toLowerCase());case"equals":return t===n;case"starts_with":return t.startsWith(a.value)||n.startsWith(a.value);default:return!1}}static evaluateDateCondition(t,e,a){let n=new Date(t),i=new Date(e.transactionDate);switch(a.operator){case"equals":return n.toDateString()===i.toDateString();case"greater_than":return n>i;case"less_than":return n<i;case"between":let r=new Date(a.value[0]),c=new Date(a.value[1]);return n>=r&&n<=c;default:return!1}}static getTransactionAmount(t){return t.lines&&t.lines.length>0?t.lines.reduce((t,e)=>t+(e.creditAmount||0)-(e.debitAmount||0),0):t.amount||0}static async getReconciliationSummary(t){let e=await this.getDb(),a=await e.collection("bank_accounts").find({businessId:t,isActive:!0}).toArray(),n=[];for(let t of a){let a=(await e.collection("bank_statements").find({bankAccountId:t._id.toString()}).sort({statementDate:-1}).limit(10).toArray())[0];n.push({accountId:t._id.toString(),accountName:t.accountName,bankName:t.bankName,accountType:t.accountType,lastReconciliationDate:t.lastReconciliationDate,recentStatement:a?{statementDate:a.statementDate,openingBalance:a.openingBalance,closingBalance:a.closingBalance,importedAt:a.importedAt}:null})}return n}}var m=a(6953);async function A(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return o.Z.json({error:"Unauthorized"},{status:401});let a=(0,m.PZ)(e);if(!a)return o.Z.json({error:"Invalid token"},{status:401});let n=await d.getBankAccounts(a.businessId);return o.Z.json({success:!0,data:n})}catch(t){return console.error("Error fetching bank accounts:",t),o.Z.json({error:"Failed to fetch bank accounts"},{status:500})}}async function h(t){try{let e=t.headers.get("Authorization")?.replace("Bearer ","");if(!e)return o.Z.json({error:"Unauthorized"},{status:401});let a=(0,m.PZ)(e);if(!a)return o.Z.json({error:"Invalid token"},{status:401});let n=await t.json(),i=await d.createBankAccount(a.businessId,n);return o.Z.json({success:!0,data:i})}catch(t){return console.error("Error creating bank account:",t),o.Z.json({error:"Failed to create bank account"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/bank/accounts/route",pathname:"/api/bank/accounts",filename:"route",bundlePath:"app/api/bank/accounts/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/bank/accounts/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:I,staticGenerationAsyncStorage:f,serverHooks:T,headerHooks:_,staticGenerationBailout:g}=p,D="/api/bank/accounts/route";function y(){return(0,c.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:f})}},6953:(t,e,a)=>{a.d(e,{PZ:()=>u,e8:()=>s,sL:()=>l});var n=a(6082),i=a.n(n),r=a(6521),c=a.n(r);let o=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class s{static generateToken(t){let e={userId:t._id,email:t.email,businessId:t.businessId,role:t.role};return i().sign(e,o,{expiresIn:"24h"})}static verifyToken(t){try{return i().verify(t,o)}catch(t){throw Error("Invalid token")}}static async hashPassword(t){return await c().hash(t,12)}static async verifyPassword(t,e){return await c().compare(t,e)}static generateApiKey(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e="";for(let a=0;a<32;a++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}}let u=s.verifyToken,l=s.verifyToken},777:(t,e,a)=>{a.r(e),a.d(e,{default:()=>r});var n=a(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let i=process.env.MONGODB_URI,r=new n.MongoClient(i,{}).connect()},739:(t,e,a)=>{var n,i,r,c,o,s,u,l,d,m,A,h,p,I,f,T,_,g,D;a.d(e,{E_:()=>p,UW:()=>s,Xy:()=>h,_q:()=>m,dm:()=>I,eR:()=>o,l5:()=>T,sA:()=>f,z1:()=>A}),function(t){t.ANNUAL="annual",t.QUARTERLY="quarterly",t.MONTHLY="monthly",t.PROJECT="project"}(n||(n={})),function(t){t.DRAFT="draft",t.SUBMITTED="submitted",t.APPROVED="approved",t.REJECTED="rejected",t.ARCHIVED="archived"}(i||(i={})),function(t){t.MONTHLY="monthly",t.QUARTERLY="quarterly",t.ANNUAL="annual"}(r||(r={})),function(t){t.OPTIMISTIC="optimistic",t.PESSIMISTIC="pessimistic",t.REALISTIC="realistic",t.CUSTOM="custom"}(c||(c={})),function(t){t.FIFO="fifo",t.LIFO="lifo",t.WEIGHTED_AVERAGE="weighted_average",t.SPECIFIC_IDENTIFICATION="specific_identification"}(o||(o={})),function(t){t.IN="in",t.OUT="out",t.ADJUSTMENT="adjustment",t.TRANSFER="transfer"}(s||(s={})),function(t){t.PURCHASE="purchase",t.SALE="sale",t.ADJUSTMENT="adjustment",t.TRANSFER="transfer",t.RETURN="return"}(u||(u={})),function(t){t.CHECKING="checking",t.SAVINGS="savings",t.BUSINESS="business",t.CREDIT_CARD="credit_card"}(l||(l={})),function(t){t.MANUAL="manual",t.FILE_IMPORT="file_import",t.API="api"}(d||(d={})),function(t){t.AUTO="auto",t.MANUAL="manual",t.RULE_BASED="rule_based"}(m||(m={})),function(t){t.AMOUNT_DIFFERENCE="amount_difference",t.MISSING_TRANSACTION="missing_transaction",t.DUPLICATE_TRANSACTION="duplicate_transaction",t.TIMING_DIFFERENCE="timing_difference"}(A||(A={})),function(t){t.MONTHLY="monthly",t.QUARTERLY="quarterly",t.ANNUAL="annual",t.SEMI_ANNUAL="semi_annual"}(h||(h={})),function(t){t.SALES="sales",t.INCOME="income",t.VAT="vat",t.GST="gst",t.WITHHOLDING="withholding",t.PAYROLL="payroll",t.PROPERTY="property"}(p||(p={})),function(t){t.DRAFT="draft",t.READY_TO_FILE="ready_to_file",t.FILED="filed",t.PAID="paid",t.OVERDUE="overdue",t.CANCELLED="cancelled"}(I||(I={})),function(t){t.STRAIGHT_LINE="straight_line",t.DECLINING_BALANCE="declining_balance",t.SUM_OF_YEARS="sum_of_years",t.UNITS_OF_PRODUCTION="units_of_production"}(f||(f={})),function(t){t.ACTIVE="active",t.UNDER_CONSTRUCTION="under_construction",t.DISPOSED="disposed",t.IMPAIRED="impaired",t.RETIRED="retired"}(T||(T={})),function(t){t.PPE="ppe",t.INTANGIBLE="intangible",t.INVESTMENT_PROPERTY="investment_property",t.BIOLOGICAL_ASSETS="biological_assets"}(_||(_={})),function(t){t.FAIR_VALUE_LESS_COSTS="fair_value_less_costs",t.VALUE_IN_USE="value_in_use"}(g||(g={})),function(t){t.SALE="sale",t.SCRAP="scrap",t.TRADE_IN="trade_in",t.DONATION="donation"}(D||(D={}))}};var e=require("../../../../webpack-runtime.js");e.C(t);var a=t=>e(e.s=t),n=e.X(0,[1638,6206,7145],()=>a(5463));module.exports=n})();