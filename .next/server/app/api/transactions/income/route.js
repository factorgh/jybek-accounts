"use strict";(()=>{var e={};e.id=864,e.ids=[864,9962],e.modules={8013:e=>{e.exports=require("mongodb")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},6500:(e,t,n)=>{n.r(t),n.d(t,{headerHooks:()=>w,originalPathname:()=>f,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>A});var a={};n.r(a),n.d(a,{POST:()=>l});var i=n(5419),r=n(9108),o=n(9678),c=n(8070),s=n(6953),d=n(9962),u=n(1023);async function l(e){try{let t;let a=e.headers.get("Authorization"),i=e.headers.get("X-API-Key");if(a?.startsWith("Bearer ")){let e=a.substring(7);t=s.e8.verifyToken(e).businessId}else{if(!i)return c.Z.json({error:"Authentication required"},{status:401});let e=await Promise.resolve().then(n.bind(n,777)).then(e=>e.default).then(e=>e.db("jybek_accounts")),a=await e.collection("apiClients").findOne({apiKey:i,isActive:!0});if(!a)return c.Z.json({error:"Invalid API key"},{status:401});t=a.businessId}let{incomeAccountId:r,cashAccountId:o,amount:l,transactionDate:p,description:m,reference:y}=await e.json();if(!r||!o||!l||!p||!m)return c.Z.json({error:"Missing required fields"},{status:400});let h=await u.B.getAccountById(r),w=await u.B.getAccountById(o);if(!h||h.businessId!==t)return c.Z.json({error:"Invalid income account"},{status:400});if(!w||w.businessId!==t)return c.Z.json({error:"Invalid cash account"},{status:400});let A=await d.LedgerService.postIncome(t,r,o,l,new Date(p),m,y);return c.Z.json({transactionId:A._id,transactionNumber:A.transactionNumber,message:"Income transaction created successfully"})}catch(e){return console.error("Income transaction error:",e),c.Z.json({error:e instanceof Error?e.message:"Internal server error"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/transactions/income/route",pathname:"/api/transactions/income",filename:"route",bundlePath:"app/api/transactions/income/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/transactions/income/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:h,headerHooks:w,staticGenerationBailout:A}=p,f="/api/transactions/income/route";function b(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},6953:(e,t,n)=>{n.d(t,{PZ:()=>d,e8:()=>s,sL:()=>u});var a=n(6082),i=n.n(a),r=n(6521),o=n.n(r);let c=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class s{static generateToken(e){let t={userId:e._id,email:e.email,businessId:e.businessId,role:e.role};return i().sign(t,c,{expiresIn:"24h"})}static verifyToken(e){try{return i().verify(e,c)}catch(e){throw Error("Invalid token")}}static async hashPassword(e){return await o().hash(e,12)}static async verifyPassword(e,t){return await o().compare(e,t)}static generateApiKey(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let n=0;n<32;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}}let d=s.verifyToken,u=s.verifyToken},777:(e,t,n)=>{n.r(t),n.d(t,{default:()=>r});var a=n(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let i=process.env.MONGODB_URI,r=new a.MongoClient(i,{}).connect()},1023:(e,t,n)=>{n.d(t,{B:()=>o});var a=n(8013),i=n(777),r=n(5200);class o{static getDb(){return i.default.then(e=>e.db("jybek_accounts"))}static async createAccount(e){let t=await this.getDb(),n={...e,balance:e.balance||0,createdAt:new Date,updatedAt:new Date},a=await t.collection("accounts").insertOne(n);return{...n,_id:a.insertedId.toString()}}static async getAccountsByBusiness(e){let t=await this.getDb();return await t.collection("accounts").find({businessId:e}).sort({code:1}).toArray()}static async getAccountById(e){let t=await this.getDb();return await t.collection("accounts").findOne({_id:new a.ObjectId(e)})}static async updateAccount(e,t){let n=await this.getDb(),i={...t,updatedAt:new Date};return(await n.collection("accounts").findOneAndUpdate({_id:new a.ObjectId(e)},{$set:i},{returnDocument:"after"})).value||null}static async deleteAccount(e){let t=await this.getDb();return(await t.collection("accounts").deleteOne({_id:new a.ObjectId(e)})).deletedCount>0}static async seedDefaultAccounts(e){let t=[{code:"1000",name:"Cash",type:r.Qm.Asset,isActive:!0},{code:"1100",name:"Bank Account",type:r.Qm.Asset,isActive:!0},{code:"1200",name:"Accounts Receivable",type:r.Qm.Asset,isActive:!0},{code:"2000",name:"Accounts Payable",type:r.Qm.Liability,isActive:!0},{code:"3000",name:"Owner's Capital",type:r.Qm.Equity,isActive:!0},{code:"4000",name:"Sales Revenue",type:r.Qm.Income,isActive:!0},{code:"4100",name:"Service Income",type:r.Qm.Income,isActive:!0},{code:"5000",name:"Rent Expense",type:r.Qm.Expense,isActive:!0},{code:"5100",name:"Utilities Expense",type:r.Qm.Expense,isActive:!0},{code:"5200",name:"Transport Expense",type:r.Qm.Expense,isActive:!0},{code:"5300",name:"Office Supplies",type:r.Qm.Expense,isActive:!0}],n=[];for(let a of t){let t=await this.createAccount({businessId:e,...a,balance:0});n.push(t)}return n}}},9962:(e,t,n)=>{n.d(t,{LedgerService:()=>r});var a=n(777),i=n(5200);class r{static getDb(){return a.default.then(e=>e.db("jybek_accounts"))}static async postJournalEntry(e,t,n,r,o,c){let s=await this.getDb(),d=a.default.then(e=>e.startSession());try{let a=await d;await a.withTransaction(async()=>{let d=o.reduce((e,t)=>e+t.debitAmount,0),u=o.reduce((e,t)=>e+t.creditAmount,0);if(d!==u)throw Error(`Transaction does not balance. Debits: ${d}, Credits: ${u}`);if(0===d)throw Error("Transaction must have at least one non-zero amount.");for(let t of o)if(!await s.collection("accounts").findOne({_id:t.accountId,businessId:e,isActive:!0}))throw Error(`Account with ID ${t.accountId} not found or inactive.`);let l=await this.generateTransactionNumber(s,e),p={businessId:e,transactionNumber:l,transactionDate:t,description:n,reference:r,type:i.iU.ManualJournal,isReversed:!1,createdByUserId:c,createdAt:new Date,updatedAt:new Date},m=(await s.collection("transactions").insertOne(p,{session:a})).insertedId.toString(),y=o.map(e=>({transactionId:m,accountId:e.accountId,debitAmount:e.debitAmount,creditAmount:e.creditAmount,description:e.description,createdAt:new Date}));await s.collection("transactionLines").insertMany(y,{session:a}),await this.updateAccountBalances(s,e,y,a)});let u=await s.collection("transactions").findOne({businessId:e,transactionNumber:(await this.generateTransactionNumber(s,e)).replace(/\d+$/,String(parseInt((await this.generateTransactionNumber(s,e)).split("-").pop()||"0")-1))});if(!u)throw Error("Failed to retrieve created transaction");return u}catch(e){throw e}}static async postIncome(e,t,n,a,i,r,o,c){if(a<=0)throw Error("Income amount must be greater than zero.");let s=[{accountId:n,debitAmount:a,creditAmount:0,description:"Income received"},{accountId:t,debitAmount:0,creditAmount:a,description:r}];return await this.postJournalEntry(e,i,r,o,s,c)}static async postExpense(e,t,n,a,i,r,o,c){if(a<=0)throw Error("Expense amount must be greater than zero.");let s=[{accountId:t,debitAmount:a,creditAmount:0,description:r},{accountId:n,debitAmount:0,creditAmount:a,description:"Expense paid"}];return await this.postJournalEntry(e,i,r,o,s,c)}static async postOpeningBalance(e,t,n,a,i,r){if(t<0)throw Error("Opening balance cannot be negative.");return await this.postJournalEntry(e,i,"Opening Balance","OB-001",[{accountId:a,debitAmount:t,creditAmount:0,description:"Opening balance - Cash"},{accountId:n,debitAmount:0,creditAmount:t,description:"Opening balance - Owner's Capital"}],r)}static async reverseTransaction(e,t,n){let i=await this.getDb(),r=await i.collection("transactions").findOne({_id:e});if(!r)throw Error(`Transaction with ID ${e} not found.`);if(r.isReversed)throw Error("Transaction is already reversed.");let o=(await i.collection("transactionLines").find({transactionId:e}).toArray()).map(e=>({accountId:e.accountId,debitAmount:e.creditAmount,creditAmount:e.debitAmount,description:`Reversal: ${e.description}`})),c=await this.postJournalEntry(r.businessId,new Date,`Reversal: ${r.description} - ${t}`,`REV-${r.transactionNumber}`,o,n),s=await a.default.then(e=>e.startSession());return await s.withTransaction(async()=>{await i.collection("transactions").updateOne({_id:e},{$set:{isReversed:!0,reversedByTransactionId:c._id,updatedAt:new Date}},{session:s})}),c}static async generateTransactionNumber(e,t){let n=new Date().getFullYear(),a=`JE-${n}-`,i=await e.collection("transactions").find({businessId:t,transactionNumber:{$regex:`^${a}`}}).sort({transactionNumber:-1}).limit(1).toArray(),r=1;return i.length>0&&(r=parseInt(i[0].transactionNumber.split("-").pop()||"0")+1),`${a}${r.toString().padStart(6,"0")}`}static async updateAccountBalances(e,t,n,a){for(let r of n){let n=await e.collection("accounts").findOne({_id:r.accountId,businessId:t});if(!n)continue;let o=0;o=n.type===i.Qm.Asset||n.type===i.Qm.Expense?r.debitAmount-r.creditAmount:r.creditAmount-r.debitAmount,await e.collection("accounts").updateOne({_id:r.accountId},{$inc:{balance:o},$set:{updatedAt:new Date}},{session:a})}}}},5200:(e,t,n)=>{var a,i,r,o,c,s,d,u;n.d(t,{Qm:()=>a,iU:()=>i}),function(e){e.Asset="asset",e.Liability="liability",e.Equity="equity",e.Income="income",e.Expense="expense"}(a||(a={})),function(e){e.ManualJournal="manual_journal",e.Income="income",e.Expense="expense",e.Invoice="invoice",e.InvoicePayment="invoice_payment",e.OpeningBalance="opening_balance"}(i||(i={})),function(e){e.Draft="draft",e.Sent="sent",e.Paid="paid",e.Cancelled="cancelled"}(r||(r={})),function(e){e.Draft="draft",e.Sent="sent",e.Accepted="accepted",e.Rejected="rejected",e.Expired="expired",e.ConvertedToInvoice="converted_to_invoice"}(o||(o={})),function(e){e.Daily="daily",e.Weekly="weekly",e.BiWeekly="bi_weekly",e.Monthly="monthly",e.Quarterly="quarterly",e.Annually="annually"}(c||(c={})),function(e){e.Draft="draft",e.InProgress="in_progress",e.Completed="completed",e.Cancelled="cancelled"}(s||(s={})),function(e){e.Unmatched="unmatched",e.Matched="matched",e.Reconciled="reconciled",e.Excluded="excluded"}(d||(d={})),function(e){e.Deposit="deposit",e.Withdrawal="withdrawal",e.Check="check",e.Transfer="transfer",e.BankCharge="bank_charge",e.Interest="interest",e.Other="other"}(u||(u={}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[1638,6206,7145],()=>n(6500));module.exports=a})();