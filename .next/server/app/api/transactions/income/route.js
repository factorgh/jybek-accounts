"use strict";(()=>{var e={};e.id=864,e.ids=[864,9962],e.modules={8013:e=>{e.exports=require("mongodb")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},6500:(e,t,n)=>{n.r(t),n.d(t,{headerHooks:()=>h,originalPathname:()=>b,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>A});var a={};n.r(a),n.d(a,{POST:()=>l});var r=n(5419),i=n(9108),c=n(9678),o=n(8070),s=n(6953),d=n(9962),u=n(1023);async function l(e){try{let t;let a=e.headers.get("Authorization"),r=e.headers.get("X-API-Key");if(a?.startsWith("Bearer ")){let e=a.substring(7);t=s.e8.verifyToken(e).businessId}else{if(!r)return o.Z.json({error:"Authentication required"},{status:401});let e=await Promise.resolve().then(n.bind(n,777)).then(e=>e.default).then(e=>e.db("jybek_accounts")),a=await e.collection("apiClients").findOne({apiKey:r,isActive:!0});if(!a)return o.Z.json({error:"Invalid API key"},{status:401});t=a.businessId}let{incomeAccountId:i,cashAccountId:c,amount:l,transactionDate:p,description:m,reference:y}=await e.json();if(!i||!c||!l||!p||!m)return o.Z.json({error:"Missing required fields"},{status:400});let w=await u.B.getAccountById(i),h=await u.B.getAccountById(c);if(!w||w.businessId!==t)return o.Z.json({error:"Invalid income account"},{status:400});if(!h||h.businessId!==t)return o.Z.json({error:"Invalid cash account"},{status:400});let A=await d.LedgerService.postIncome(t,i,c,l,new Date(p),m,y);return o.Z.json({transactionId:A._id,transactionNumber:A.transactionNumber,message:"Income transaction created successfully"})}catch(e){return console.error("Income transaction error:",e),o.Z.json({error:e instanceof Error?e.message:"Internal server error"},{status:500})}}let p=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/transactions/income/route",pathname:"/api/transactions/income",filename:"route",bundlePath:"app/api/transactions/income/route"},resolvedPagePath:"/Users/pave360limited/Documents/oaj/complete-jybek-account/jybek-accounts-nextjs/src/app/api/transactions/income/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:w,headerHooks:h,staticGenerationBailout:A}=p,b="/api/transactions/income/route";function f(){return(0,c.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:y})}},6953:(e,t,n)=>{n.d(t,{PZ:()=>d,e8:()=>s,sL:()=>u});var a=n(6082),r=n.n(a),i=n(6521),c=n.n(i);let o=process.env.JWT_SECRET||"your-super-secret-jwt-key-change-in-production";class s{static generateToken(e){let t={userId:e._id,email:e.email,businessId:e.businessId,role:e.role};return r().sign(t,o,{expiresIn:"24h"})}static verifyToken(e){try{return r().verify(e,o)}catch(e){throw Error("Invalid token")}}static async hashPassword(e){return await c().hash(e,12)}static async verifyPassword(e,t){return await c().compare(e,t)}static generateApiKey(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="";for(let n=0;n<32;n++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}}let d=s.verifyToken,u=s.verifyToken},777:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});var a=n(8013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let r=process.env.MONGODB_URI,i=new a.MongoClient(r,{}).connect()},1023:(e,t,n)=>{n.d(t,{B:()=>c});var a=n(8013),r=n(777),i=n(5200);class c{static getDb(){return r.default.then(e=>e.db("jybek_accounts"))}static async createAccount(e){let t=await this.getDb(),n={...e,balance:e.balance||0,createdAt:new Date,updatedAt:new Date},a=await t.collection("accounts").insertOne(n);return{...n,_id:a.insertedId.toString()}}static async getAccountsByBusiness(e){let t=await this.getDb();return await t.collection("accounts").find({businessId:e}).sort({code:1}).toArray()}static async getAccountById(e){let t=await this.getDb();return await t.collection("accounts").findOne({_id:new a.ObjectId(e)})}static async updateAccount(e,t){let n=await this.getDb(),r={...t,updatedAt:new Date};return await n.collection("accounts").findOneAndUpdate({_id:new a.ObjectId(e)},{$set:r},{returnDocument:"after"})}static async deleteAccount(e){let t=await this.getDb();return(await t.collection("accounts").deleteOne({_id:new a.ObjectId(e)})).deletedCount>0}static async seedDefaultAccounts(e){let t=[{code:"1000",name:"Cash",type:i.Qm.Asset,isActive:!0},{code:"1100",name:"Bank Account",type:i.Qm.Asset,isActive:!0},{code:"1200",name:"Accounts Receivable",type:i.Qm.Asset,isActive:!0},{code:"2000",name:"Accounts Payable",type:i.Qm.Liability,isActive:!0},{code:"3000",name:"Owner's Capital",type:i.Qm.Equity,isActive:!0},{code:"4000",name:"Sales Revenue",type:i.Qm.Income,isActive:!0},{code:"4100",name:"Service Income",type:i.Qm.Income,isActive:!0},{code:"5000",name:"Rent Expense",type:i.Qm.Expense,isActive:!0},{code:"5100",name:"Utilities Expense",type:i.Qm.Expense,isActive:!0},{code:"5200",name:"Transport Expense",type:i.Qm.Expense,isActive:!0},{code:"5300",name:"Office Supplies",type:i.Qm.Expense,isActive:!0}],n=[];for(let a of t){let t=await this.createAccount({businessId:e,...a,balance:0});n.push(t)}return n}}},9962:(e,t,n)=>{n.d(t,{LedgerService:()=>c});var a=n(8013),r=n(777),i=n(5200);class c{static getDb(){return r.default.then(e=>e.db("jybek_accounts"))}static async postJournalEntry(e,t,n,c,o,s){let d=await this.getDb(),u=r.default.then(e=>e.startSession());try{let r=await u;await r.withTransaction(async()=>{let u=o.reduce((e,t)=>e+t.debitAmount,0),l=o.reduce((e,t)=>e+t.creditAmount,0);if(u!==l)throw Error(`Transaction does not balance. Debits: ${u}, Credits: ${l}`);if(0===u)throw Error("Transaction must have at least one non-zero amount.");for(let t of o)if(!await d.collection("accounts").findOne({_id:new a.ObjectId(t.accountId),businessId:e,isActive:!0}))throw Error(`Account with ID ${t.accountId} not found or inactive.`);let p=await this.generateTransactionNumber(d,e),m={businessId:e,transactionNumber:p,transactionDate:t,description:n,reference:c,type:i.iU.ManualJournal,isReversed:!1,createdByUserId:s,createdAt:new Date,updatedAt:new Date},y=(await d.collection("transactions").insertOne(m,{session:r})).insertedId.toString(),w=o.map(e=>({transactionId:y,accountId:e.accountId,debitAmount:e.debitAmount,creditAmount:e.creditAmount,description:e.description,createdAt:new Date}));await d.collection("transactionLines").insertMany(w,{session:r}),await this.updateAccountBalances(d,e,w,r)});let l=await d.collection("transactions").findOne({businessId:e,transactionNumber:(await this.generateTransactionNumber(d,e)).replace(/\d+$/,String(parseInt((await this.generateTransactionNumber(d,e)).split("-").pop()||"0")-1))});if(!l)throw Error("Failed to retrieve created transaction");return l}catch(e){throw e}}static async postIncome(e,t,n,a,r,i,c,o){if(a<=0)throw Error("Income amount must be greater than zero.");let s=[{accountId:n,debitAmount:a,creditAmount:0,description:"Income received"},{accountId:t,debitAmount:0,creditAmount:a,description:i}];return await this.postJournalEntry(e,r,i,c,s,o)}static async postExpense(e,t,n,a,r,i,c,o){if(a<=0)throw Error("Expense amount must be greater than zero.");let s=[{accountId:t,debitAmount:a,creditAmount:0,description:i},{accountId:n,debitAmount:0,creditAmount:a,description:"Expense paid"}];return await this.postJournalEntry(e,r,i,c,s,o)}static async reverseTransaction(e,t,n){let r=await this.getDb(),i=await r.collection("transactions").findOne({_id:new a.ObjectId(e)});if(!i)throw Error(`Transaction with ID ${e} not found.`);if(i.isReversed)throw Error("Transaction is already reversed.");let c=(await r.collection("transactionLines").find({transactionId:e}).toArray()).map(e=>({accountId:e.accountId,debitAmount:e.creditAmount,creditAmount:e.debitAmount,description:`Reversal: ${e.description}`})),o=await this.postJournalEntry(i.businessId,new Date,`Reversal: ${i.description} - ${t}`,`REV-${i.transactionNumber}`,c,n);return await r.collection("transactions").updateOne({_id:new a.ObjectId(e)},{$set:{isReversed:!0,reversedByTransactionId:o._id,updatedAt:new Date}}),o}static async generateTransactionNumber(e,t){let n=new Date().getFullYear(),a=`JE-${n}-`,r=await e.collection("transactions").find({businessId:t,transactionNumber:{$regex:`^${a}`}}).sort({transactionNumber:-1}).limit(1).toArray(),i=1;return r.length>0&&(i=parseInt(r[0].transactionNumber.split("-").pop()||"0")+1),`${a}${i.toString().padStart(6,"0")}`}static async updateAccountBalances(e,t,n,r){for(let c of n){let n=await e.collection("accounts").findOne({_id:new a.ObjectId(c.accountId),businessId:t});if(!n)continue;let o=0;o=n.type===i.Qm.Asset||n.type===i.Qm.Expense?c.debitAmount-c.creditAmount:c.creditAmount-c.debitAmount,await e.collection("accounts").updateOne({_id:new a.ObjectId(c.accountId)},{$inc:{balance:o},$set:{updatedAt:new Date}},{session:r})}}}},5200:(e,t,n)=>{var a,r,i,c,o,s,d,u;n.d(t,{Qm:()=>a,iU:()=>r}),function(e){e.Asset="asset",e.Liability="liability",e.Equity="equity",e.Income="income",e.Expense="expense"}(a||(a={})),function(e){e.ManualJournal="manual_journal",e.Income="income",e.Expense="expense",e.Invoice="invoice",e.InvoicePayment="invoice_payment",e.OpeningBalance="opening_balance"}(r||(r={})),function(e){e.Draft="draft",e.Sent="sent",e.Paid="paid",e.Cancelled="cancelled"}(i||(i={})),function(e){e.Draft="draft",e.Sent="sent",e.Accepted="accepted",e.Rejected="rejected",e.Expired="expired",e.ConvertedToInvoice="converted_to_invoice"}(c||(c={})),function(e){e.Daily="daily",e.Weekly="weekly",e.BiWeekly="bi_weekly",e.Monthly="monthly",e.Quarterly="quarterly",e.Annually="annually"}(o||(o={})),function(e){e.Draft="draft",e.InProgress="in_progress",e.Completed="completed",e.Cancelled="cancelled"}(s||(s={})),function(e){e.Unmatched="unmatched",e.Matched="matched",e.Reconciled="reconciled",e.Excluded="excluded"}(d||(d={})),function(e){e.Deposit="deposit",e.Withdrawal="withdrawal",e.Check="check",e.Transfer="transfer",e.BankCharge="bank_charge",e.Interest="interest",e.Other="other"}(u||(u={}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[1638,6206,7145],()=>n(6500));module.exports=a})();